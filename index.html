<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildsheet Generator</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f4f4f4, #e0e0e0);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Title Banner */
        #title-banner {
            width: 100%;
            background: linear-gradient(135deg, #003366, #004080);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
#export-container {
    width: 100%;
    padding: 20px;
    background: white; /* Ensure the background is white for the PDF */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
}

#export-container #panel {
    margin-bottom: 20px; /* Add space between rails and pick list */
}

#export-container #pick-list {
    margin-top: 20px; /* Add space between rails and pick list */
}
        #title-banner h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        #title-banner p {
            margin: 0;
            font-size: 16px;
            color: #FFA500;
        }

        /* Navigation Tabs */
        #nav-tabs {
            margin-top: 100px;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #nav-tabs button {
            padding: 10px 20px;
            border: none;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #nav-tabs button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Load Controller Table */
        #load-controller-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        #load-controller-table th,
        #load-controller-table td {
            padding: 12px;
            text-align: left;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #load-controller-table th {
            background: linear-gradient(135deg, #003366, #004080);
            color: white;
            font-weight: bold;
        }

        /* Toolbar */
        #toolbar {
            position: fixed;
            left: 20px;
            top: 150px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #toolbar button {
            padding: 12px 20px;
            border: none;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Panel & Rails */
        #panel {
            width: 900px;
            height: 1000px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        /* Rail Styles */
        .rail {
            width: 900px; /* Fixed width for the rail */
            height: 70px; /* Fixed height for the rail */
            background: rgba(221, 221, 221, 0.8); /* Light grey background for the rail */
            border-bottom: 2px solid #bbb; /* Rail border */
            border-radius: 10px;
            position: relative; /* Make the rail a positioning context for parts */
            margin-bottom: 20px; /* Space between rails */
        }

        /* Part Styles */
        .part {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            position: absolute; /* Position parts absolutely within the rail */
            top: 0; /* Align parts to the top of the rail */
            left: 0; /* Start from the left edge of the rail */
            margin: 0; /* Remove margin */
            flex-shrink: 0; /* Prevent parts from shrinking */
            cursor: grab; /* Change cursor to indicate draggable */
        }

        .part:active {
            cursor: grabbing; /* Change cursor when dragging */
        }

        /* Specific Module Sizes */
        .part.NET {
            width: 200px; /* Fixed width */
            height: 70px; /* Fixed height */
            background: rgba(128, 0, 128, 0.8); /* Purple */
        }

        .part.PSU {
            width: 200px; /* Fixed width */
            height: 70px; /* Fixed height */
            background: rgba(128, 128, 128, 0.8); /* Grey */
        }

        .part.LINK {
            width: 150px; /* Fixed width */
            height: 70px; /* Fixed height */
            background: rgba(255, 165, 0, 0.8); /* Orange */
        }

        .part.IO {
            width: 200px; /* Fixed width */
            height: 70px; /* Fixed height */
            background: rgba(255, 165, 0, 0.8); /* Orange */
        }

        .part:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* Part Colors */
        .NET { background: rgba(128, 0, 128, 0.8); }
        .PSU { background: rgba(128, 128, 128, 0.8); }
        .LINK { background: rgba(255, 165, 0, 0.8); }
        .IO { background: rgba(255, 165, 0, 0.8); }

        /* Dropdowns */
        .part select {
            width: 50px;
            padding: 1px;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Pick List */
        #pick-list {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #pick-list h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            font-weight: bold;
        }

        #pick-list-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        #pick-list-table th,
        #pick-list-table td {
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #pick-list-table th {
            background: linear-gradient(135deg, #003366, #004080);
            color: white;
            font-weight: bold;
        }

        /* Arrow Styles */
        .part .arrow {
            position: absolute;
            top: 0;
            cursor: pointer;
            font-size: 20px;
            color: #00000;
            user-select: none;
        }

        .part .arrow.left {
            left: 5px;
        }

        .part .arrow.right {
            right: 5px;
        }
    </style>
</head>
<body>
<!-- Wrap the rails and pick list in a container -->
</div>
    <div id="title-banner">
        <h1>Buildsheet Generator</h1>
        <p>Created by Jake Skidmore</p>
    </div>

    <!-- Move the Tabs Below the Title -->
    <div id="nav-tabs">
        <button onclick="openTab('main-tab')">Main Page</button>
        <button onclick="openTab('load-controller-tab')">Load Controllers</button>
    </div>

    <!-- Main Content (Default) -->
<div id="main-tab">
    <!-- Left Toolbar -->
<div id="toolbar">
    <button onclick="addPart('PSU')">Add PSU</button>
    <button onclick="addPart('NET')">Add NET</button>
    <button onclick="addPart('LINK')">Add LINK</button>
    <button onclick="addPart('IO')">Add IO</button>
    <button onclick="showLSelectionPopup(2)">2 Zone</button>
    <button onclick="showLSelectionPopup(4)">4 Zone</button>
    <button onclick="showLSelectionPopup(8)">8 Zone</button>
    <button onclick="showLSelectionPopup(12)">12 Zone</button>
    <button onclick="exportToPDF()">Export to PDF</button>
</div>

    <!-- Hide Button -->
    <button id="hideButton" onclick="toggleToolbar()">Hide</button>

    <!-- Rail Selector -->
    <div id="controls">
        <label for="railSelect">Select Rails:</label>
        <select id="railSelect" onchange="generateRails()">
            <option value="2">2 Rail</option>
            <option value="3">3 Rail</option>
            <option value="6">6 Rail</option>
            <option value="10">10 Rail</option>
        </select>
    </div>

    <!-- Rails Container -->
    <div id="panel"></div>

    <!-- Pick List -->
    <div id="pick-list">
        <h3>PICK LIST</h3>
        <table id="pick-list-table">
            <thead>
                <tr>
                    <th>Part Number</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>

    <!-- Load Controller Tab (Initially Hidden) -->
    <div id="load-controller-tab" style="display: none;">
        <h2>Load Controller Chart</h2>
        <table id="load-controller-table">
            <thead>
                <tr>
                    <th>Space</th>
                    <th>Load Controllers</th>
                    <th>Devices</th>
                    <th>Module Draw</th>
                    <th>Device Draw</th>
                    <th>Total Draw</th>
                    <th>Calculate</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>

    <script>
    
        const powerDrawMap = {
            "NET, LV": 120,
            "NET, DLI": 150,
            "LINK, LV": 100,
            "LINK, DIMU": 100,
            "LINK, SW": 50,
            "LINK, PLUG": 50,
            "IO, IO": 145,
            "Sensor": 20,
            "Keypad": 5
        };
	function showLSelectionPopup(zoneCount) {
    // Create the popup container
    const popup = document.createElement("div");
    popup.style.position = "fixed";
    popup.style.top = "50%";
    popup.style.left = "50%";
    popup.style.transform = "translate(-50%, -50%)";
    popup.style.backgroundColor = "white";
    popup.style.padding = "20px";
    popup.style.border = "1px solid #ccc";
    popup.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.2)";
    popup.style.zIndex = "1000";

    // Create the dropdown for L selection
    const dropdown = document.createElement("select");
    dropdown.innerHTML = generateDropdownOptions(1, 99, "L"); // Generate L options (L1, L2, ..., L99)
    popup.appendChild(dropdown);

    // Create the confirm button
    const confirmButton = document.createElement("button");
    confirmButton.textContent = "Confirm";
    confirmButton.style.marginTop = "10px";
    confirmButton.onclick = () => {
        const selectedL = dropdown.value; // Get the selected L value
        document.body.removeChild(popup); // Remove the popup
        addZone(zoneCount, selectedL); // Add the parts with the selected L value
    };
    popup.appendChild(confirmButton);

    // Add the popup to the body
    document.body.appendChild(popup);
}
function addZone(zoneCount, selectedL) {
    // Add the specified number of LINK parts
    for (let i = 0; i < zoneCount; i++) {
        addPart('LINK', selectedL); // Pass the selectedL value to the addPart function
    }
}

function addPart(type, selectedL = null) {
    const part = document.createElement("div");
    part.classList.add("part", type);
    part.draggable = true;

    let dropdown = `<select class="type-dropdown" onchange="updatePickList()">${getDropdownOptions(type)}</select>`;
    let bottomDropdowns = getBottomDropdowns(type);

    part.innerHTML = `
        <div class="arrow left" onclick="movePart(this.parentElement, -50)">&#9664;</div>
        <div class="arrow right" onclick="movePart(this.parentElement, 50)">&#9654;</div>
        ${dropdown}
        <div class="bottom-dropdowns">${bottomDropdowns}</div>
    `;

    part.addEventListener("dblclick", () => showDeletePopup(part));
    part.addEventListener("dragstart", handleDragStart);
    part.addEventListener("dragend", handleDragEnd);

    const partWidth = getPartWidth(type);
    
    console.log("Adding part:", type, "| Selected L:", selectedL);

    for (let rail of rails) {
        const railChildren = Array.from(rail.children);
        const totalWidth = railChildren.reduce((sum, el) => sum + getPartWidth(el.classList[1]), 0);

        if (totalWidth + partWidth <= 900) {
            part.style.left = `${totalWidth}px`;
            rail.appendChild(part);
            console.log("Part added to rail at position:", totalWidth);

            // Ensure dropdowns update after rendering
            setTimeout(() => {
                const lDropdowns = part.querySelectorAll('.bottom-dropdowns select');
                console.log("Dropdowns found in new part:", lDropdowns.length);
                if (lDropdowns.length === 0) {
                    console.warn("No dropdowns found in new part! Check HTML structure.");
                }
                lDropdowns.forEach(dropdown => {
                    console.log("Before update, dropdown value:", dropdown.value);
                    dropdown.value = selectedL;
                    console.log("After update, dropdown value:", dropdown.value);
                });
            }, 50); // Slight delay ensures dropdowns are rendered

            updatePickList();
            updatePanelSizeSelection();
            generateLoadControllerTable();
            return;
        }
    }

    // If no rail has space, create a new rail
    const newRail = document.createElement("div");
    newRail.classList.add("rail");
    newRail.addEventListener("dragover", handleDragOver);
    newRail.addEventListener("drop", handleDrop);
    panel.appendChild(newRail);
    rails.push(newRail);

    part.style.left = "0";
    newRail.appendChild(part);
    console.log("Part added to a new rail.");

    // Ensure dropdowns update after rendering
    setTimeout(() => {
        const lDropdowns = part.querySelectorAll('.bottom-dropdowns select');
        console.log("Dropdowns found in new part (new rail):", lDropdowns.length);
        if (lDropdowns.length === 0) {
            console.warn("No dropdowns found in new part (new rail)! Check HTML structure.");
        }
        lDropdowns.forEach(dropdown => {
            console.log("Before update, dropdown value:", dropdown.value);
            dropdown.value = selectedL;
            console.log("After update, dropdown value:", dropdown.value);
        });
    }, 50);

    updatePickList();
    updatePanelSizeSelection();
    generateLoadControllerTable();
}



        function openTab(tabId) {
            document.getElementById("main-tab").style.display = tabId === "main-tab" ? "block" : "none";
            document.getElementById("load-controller-tab").style.display = tabId === "load-controller-tab" ? "block" : "none";

            if (tabId === "load-controller-tab") {
                generateLoadControllerTable();
            }
        }

        // Function to regenerate the entire chart
        function regenerateChart() {
            generateLoadControllerTable();
        }

        function generateLoadControllerTable() {
    const tableBody = document.getElementById("load-controller-table").getElementsByTagName("tbody")[0];
    tableBody.innerHTML = ""; // Clear existing rows

    let loadMap = {}; // Store parts grouped by L values

    // Populate loadMap with parts from rails
    rails.forEach(rail => {
        Array.from(rail.children).forEach(part => {
            if (part.classList.contains("PSU")) return; // Skip PSU

            const type = part.classList[1]; // e.g., "NET, DLI", "NET, LV", "LINK, SW", "LINK, LV", "LINK, PLUG", "LINK, DIMU", "IO, IO"
            const subtype = part.querySelector(".type-dropdown").value;
            const selectedL = Array.from(part.querySelectorAll(".bottom-dropdowns select"))
                .map(select => select.value)
                .filter(value => value.startsWith("L")); // Get L values

            selectedL.forEach(L => {
                if (!loadMap[L]) loadMap[L] = {}; // Use an object to store parts and their counts
                const partKey = `${type}, ${subtype}`;
                loadMap[L][partKey] = (loadMap[L][partKey] || 0) + 1; // Increment the count for this part
            });
        });
    });

    // Populate the table
    Object.keys(loadMap).forEach(L => {
        const row = document.createElement("tr");

        // Generate space input field
        const spaceCell = document.createElement("td");
        spaceCell.innerHTML = `<input type="text" placeholder="Enter Space">`;
        row.appendChild(spaceCell);

        // Generate load controllers list (with full part numbers and quantities)
        const loadControllersCell = document.createElement("td");
        const partList = Object.entries(loadMap[L]).map(([part, count]) => {
            const [type, subtype] = part.split(", ");
            const partNumber = partNumberMap[part] || part; // Use full part number if available
            return `${partNumber} (x${count})`; // Display part number with quantity
        }).join("<br>"); // Display each part number on a new line
        loadControllersCell.innerHTML = partList;
        row.appendChild(loadControllersCell);

        // Generate devices dropdown
        const devicesCell = document.createElement("td");
        devicesCell.innerHTML = `
            <label>Keypads:</label> 
            <select class="device-select" data-type="Keypad">
                ${generateDeviceOptions()}
            </select>
            <br>
            <label>Sensors:</label> 
            <select class="device-select" data-type="Sensor">
                ${generateDeviceOptions()}
            </select>
        `;
        row.appendChild(devicesCell);

        // Generate Module Draw column
        const moduleDrawCell = document.createElement("td");
        const moduleDraw = calculateModuleDraw(loadMap[L]);
        moduleDrawCell.textContent = moduleDraw;
        row.appendChild(moduleDrawCell);

        // Generate Device Draw column
        const deviceDrawCell = document.createElement("td");
        deviceDrawCell.textContent = "0 mA"; // Initial value
        row.appendChild(deviceDrawCell);

        // Generate Total Draw column
        const totalDrawCell = document.createElement("td");
        totalDrawCell.textContent = "0 mA"; // Initial value
        row.appendChild(totalDrawCell);

        // Generate Calculate button
        const calculateCell = document.createElement("td");
        calculateCell.innerHTML = `<button onclick="calculateTotalDraw(this)">Calculate</button>`;
        row.appendChild(calculateCell);

        tableBody.appendChild(row);
    });

    // Add event listeners to all dropdowns
    addDropdownListeners();
}

// Function to calculate module draw (total power draw of parts)
function calculateModuleDraw(partsObject) {
    const totalPower = Object.entries(partsObject).reduce((sum, [part, count]) => {
        return sum + (powerDrawMap[part] || 0) * count; // Multiply power draw by quantity
    }, 0);
    return totalPower + " mA";
}

        // Function to calculate total draw (module draw + device draw)
        function calculateTotalDraw(button) {
            const row = button.closest("tr");

            // Get module draw and device draw
            const moduleDraw = row.children[3].textContent.replace(" mA", "");
            const deviceDraw = calculateDeviceDraw(row).replace(" mA", "");

            // Calculate total draw
            const totalDraw = parseInt(moduleDraw) + parseInt(deviceDraw);
            row.children[5].textContent = totalDraw + " mA"; // Update Total Draw column
        }

        // Function to generate device options
        function generateDeviceOptions() {
            return Array.from({ length: 11 }, (_, i) => `<option value="${i}">${i}</option>`).join("");
        }

        // Function to add event listeners to all dropdowns
        function addDropdownListeners() {
            const dropdowns = document.querySelectorAll(".device-select");
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener("change", function () {
                    const row = this.closest("tr");
                    const deviceDraw = calculateDeviceDraw(row);
                    row.children[4].textContent = deviceDraw; // Update Device Draw column
                });
            });
        }

        const partNumberMap = {
            "NET, LV": "ZUMNET-DIN-16A-LV",
            "NET, DLI": "ZUMNET-DIN-DLI",
            "LINK, LV": "ZUMLINK-DIN-16A-LV",
            "LINK, DIMU": "ZUMLINK-DIN-DIMU",
            "LINK, SW": "ZUMLINK-DIN-20A-SW",
            "LINK, PLUG": "ZUMLINK-DIN-20A-PLUG",
            "IO, IO": "ZUMLINK-DIN-IO",
            "PSU, PSU": "ZUMLINK-DIN-PSU",
            "2 rail": "DIN-EN-2x18",
            "3 rail": "DIN-EN-3x18",
            "6 rail": "DIN-EN-6x18",
            "10 rail": "DIN-EN-10x18",
        };

        function toggleToolbar() {
            const toolbar = document.getElementById("toolbar");
            const button = document.getElementById("hideButton");
            toolbar.style.display = toolbar.style.display === "none" ? "flex" : "none";
            button.textContent = toolbar.style.display === "none" ? "Show" : "Hide";
        }

        const panel = document.getElementById("panel");
        let rails = [];

        function generateRails() {
            panel.innerHTML = "";
            rails = [];
            const railCount = parseInt(document.getElementById("railSelect").value);
            
            for (let i = 0; i < railCount; i++) {
                const rail = document.createElement("div");
                rail.classList.add("rail");
                panel.appendChild(rail);
                rails.push(rail);
            }
            updatePickList();
        }

        // Function to add a part
        let lastUsedRailIndex = 0; // Track the last rail where a part was added

function addPart(type, selectedL = null) {
    const part = document.createElement("div");
    part.classList.add("part", type);
    part.draggable = true;

    let dropdown = `<select class="type-dropdown" onchange="updatePickList()">${getDropdownOptions(type)}</select>`;
    let bottomDropdowns = getBottomDropdowns(type);

    part.innerHTML = `
        <div class="arrow left" onclick="movePart(this.parentElement, -50)">&#9664;</div>
        <div class="arrow right" onclick="movePart(this.parentElement, 50)">&#9654;</div>
        ${dropdown}
        <div class="bottom-dropdowns">${bottomDropdowns}</div>
    `;

    part.addEventListener("dblclick", () => showDeletePopup(part));
    part.addEventListener("dragstart", handleDragStart);
    part.addEventListener("dragend", handleDragEnd);

    const partWidth = getPartWidth(type);

    // 1️⃣ Always start with the last used rail
    let rail = rails[lastUsedRailIndex];

    if (rail) {
        const railChildren = Array.from(rail.children);
        const totalWidth = railChildren.reduce((sum, el) => sum + getPartWidth(el.classList[1]), 0);

        if (totalWidth + partWidth <= 900) {
            part.style.left = `${totalWidth}px`;
            rail.appendChild(part);
            console.log("Added part to rail index:", lastUsedRailIndex);

            updateDropdowns(part, selectedL);
            updatePickList(); // Ensure picklist is updated
            return;
        }
    }

    // 2️⃣ Move to the next rail and ensure all future parts go there
    lastUsedRailIndex++; 
    if (lastUsedRailIndex >= rails.length) {
        // If no available rails, create a new one
        const newRail = document.createElement("div");
        newRail.classList.add("rail");
        newRail.addEventListener("dragover", handleDragOver);
        newRail.addEventListener("drop", handleDrop);
        panel.appendChild(newRail);
        rails.push(newRail);
    }

    // 3️⃣ Add part to the new rail
    rail = rails[lastUsedRailIndex];
    part.style.left = "0";
    rail.appendChild(part);
    console.log("Added part to NEW rail index:", lastUsedRailIndex);

    updateDropdowns(part, selectedL);
    updatePickList(); // Ensure picklist is updated
}

// Separate function to update dropdowns after part is added
function updateDropdowns(part, selectedL) {
    setTimeout(() => {
        if (selectedL) {
            const lDropdowns = part.querySelectorAll('.bottom-dropdowns select');
            console.log("Dropdowns found in new part:", lDropdowns.length);
            
            lDropdowns.forEach(dropdown => {
                console.log("Before update, dropdown value:", dropdown.value);
                dropdown.value = selectedL;
                console.log("After update, dropdown value:", dropdown.value);
            });
        }
    }, 50);
}

// Function to update the pick list
function updatePickList() {
    const pickListTable = document.getElementById("pick-list-table").getElementsByTagName("tbody")[0];
    pickListTable.innerHTML = "";

    const partCounts = {};

    // Count parts
    rails.forEach(rail => {
        Array.from(rail.children).forEach(part => {
            const type = part.classList[1];
            const subtype = part.querySelector(".type-dropdown").value;
            const key = `${type}, ${subtype}`;
            partCounts[key] = (partCounts[key] || 0) + 1;
        });
    });

    // Add rails to the pick list
    const railCount = parseInt(document.getElementById("railSelect").value);
    const railKey = `${railCount} rail`;
    partCounts[railKey] = 1;

    // Populate the pick list table
    for (const [key, count] of Object.entries(partCounts)) {
        const partNumber = partNumberMap[key];
        if (partNumber) {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${partNumber}</td><td>${count}</td>`;
            pickListTable.appendChild(row);
        }
    }
}
        // Function to show a delete confirmation popup
        function showDeletePopup(part) {
            const confirmDelete = confirm("Are you sure you want to delete this part?");
            if (confirmDelete) {
                part.remove(); // Remove the part from the rail
                updatePickList();
                updatePanelSizeSelection(); // Update panel size selection
                generateLoadControllerTable(); // Update Load Controller chart
            }
        }

        let draggedPart = null;

        function handleDragStart(e) {
            draggedPart = this;
            e.dataTransfer.setData("text/plain", ""); // Required for Firefox
            this.style.opacity = "0.4";
        }

        function handleDragEnd() {
            this.style.opacity = "1";
            draggedPart = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); // Allow dropping
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedPart) {
                const rail = this;
                const dropX = e.clientX - rail.getBoundingClientRect().left;

                // Snap the drop position to 50px intervals
                let snappedX = Math.round(dropX / 50) * 50;

                // Ensure the part doesn't overflow the rail
                const partWidth = getPartWidth(draggedPart.classList[1]);
                const railWidth = rail.offsetWidth;
                const maxX = railWidth - partWidth;

                if (snappedX < 0) {
                    snappedX = 0; // Snap to the start of the rail
                } else if (snappedX > maxX) {
                    snappedX = maxX; // Snap to the end of the rail
                }

                // Remove the dragged part from its current rail (if any)
                if (draggedPart.parentElement) {
                    draggedPart.parentElement.removeChild(draggedPart);
                }

                // Position the dragged part at the snapped position
                draggedPart.style.left = `${snappedX}px`;
                rail.appendChild(draggedPart);

                // Recalculate part positions to avoid overlaps
                let currentWidth = 0;
                Array.from(rail.children).forEach(part => {
                    part.style.left = `${currentWidth}px`;
                    currentWidth += getPartWidth(part.classList[1]);
                });

                updatePickList();
                generateLoadControllerTable(); // Update Load Controller chart
            }
        }

        // Add drag-and-drop event listeners to all rails
        function addDragAndDropListeners() {
            rails.forEach(rail => {
                rail.addEventListener("dragover", handleDragOver);
                rail.addEventListener("drop", handleDrop);
            });
        }

        // Call this function after creating new rails
        addDragAndDropListeners();

        // Helper function to get the exact width of a part based on its type
        function getPartWidth(type) {
            switch (type) {
                case "NET":
                    return 200; // NET parts are 200px wide
                case "PSU":
                    return 200; // PSU parts are 200px wide
                case "LINK":
                    return 150; // LINK parts are 150px wide
                case "IO":
                    return 200; // IO parts are 200px wide
                default:
                    return 0;
            }
        }

        // Function to show a delete confirmation popup
        function showDeletePopup(part) {
            const confirmDelete = confirm("Are you sure you want to delete this part?");
            if (confirmDelete) {
                part.remove(); // Remove the part from the rail
                updatePickList();
                updatePanelSizeSelection(); // Update panel size selection
            }
        }

        // Function to update the panel size selection dropdown
        function updatePanelSizeSelection() {
            const railCount = rails.length;
            const railSelect = document.getElementById("railSelect");

            if (railCount <= 2) {
                railSelect.value = "2"; // 2 rails
            } else if (railCount > 2 && railCount <= 3) {
                railSelect.value = "3"; // 3-6 rails
            } else if (railCount > 3 && railCount <= 6) {
                railSelect.value = "6"; // 3-6 rails
            } else if (railCount >= 7 && railCount <= 10) {
                railSelect.value = "10"; // 7-10 rails
            } else if (railCount > 10) {
                alert("Error: Maximum number of rails (10) exceeded!");
                railSelect.value = "10"; // Set to 10 rails
            }

            updatePickList(); // Update the pick list
        }

        // Helper function to get the exact width of a part based on its type
        function getPartWidth(type) {
            switch (type) {
                case "NET":
                    return 200; // NET parts are 200px wide
                case "PSU":
                    return 200; // PSU parts are 200px wide
                case "LINK":
                    return 150; // LINK parts are 150px wide
                case "IO":
                    return 200; // IO parts are 200px wide
                default:
                    return 0;
            }
        }

        function getDropdownOptions(type) {
            if (type === "NET") return "<option>LV</option><option>DLI</option>";
            if (type === "LINK") return "<option>LV</option><option>DIMU</option><option>SW</option><option>PLUG</option>";
            if (type === "IO") return "<option>IO</option>";
            return "<option>PSU</option>";
        }

       function getBottomDropdowns(type) {
    let optionsN = generateDropdownOptions(1, 99, "N");
    let optionsL = generateDropdownOptions(1, 99, "L");

    if (type === "NET") {
        return `
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsN}</select>
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsN}</select>
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
        `;
    } else if (type === "PSU") {
        return `
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
        `;
    } else if (type === "LINK" || type === "IO") {
        return `
            <select name="bottom-dropdown" onchange="updatePickList()">${optionsL}</select>
        `;
    } else {
        return "";
    }
}

        function generateDropdownOptions(start, end, prefix) {
            return Array.from({ length: end - start + 1 }, (_, i) => `<option>${prefix}${i + start}</option>`).join("");
        }

        function updatePickList() {
            const pickListTable = document.getElementById("pick-list-table").getElementsByTagName("tbody")[0];
            pickListTable.innerHTML = "";

            const partCounts = {};

            // Count parts
            rails.forEach(rail => {
                Array.from(rail.children).forEach(part => {
                    const type = part.classList[1];
                    const subtype = part.querySelector(".type-dropdown").value;
                    const key = `${type}, ${subtype}`;
                    partCounts[key] = (partCounts[key] || 0) + 1;
                });
            });

            // Add rails to the pick list
            const railCount = parseInt(document.getElementById("railSelect").value);
            const railKey = `${railCount} rail`;
            partCounts[railKey] = 1;

            // Populate the pick list table
            for (const [key, count] of Object.entries(partCounts)) {
                const partNumber = partNumberMap[key];
                if (partNumber) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${partNumber}</td><td>${count}</td>`;
                    pickListTable.appendChild(row);
                }
            }
        }
   function exportToPDF() {
    const railsElement = document.getElementById("panel");
    const pickListElement = document.getElementById("pick-list");

    // Clone elements to avoid modifying the original DOM
    const railsClone = railsElement.cloneNode(true);
    const pickListClone = pickListElement.cloneNode(true);

    // Ensure the cloned elements are visible for export
    railsClone.style.display = "block";
    pickListClone.style.display = "block";

    // Add a page break inside the cloned elements
    const pageBreak = document.createElement("div");
    pageBreak.style.pageBreakBefore = "always";
    pageBreak.style.width = "100%";
    pageBreak.style.height = "20px"; // Some height to ensure it's recognized
    pageBreak.style.background = "white"; // Avoid any artifacts

    railsClone.appendChild(pageBreak); // Insert page break inside the railsClone

    // Create a container to hold the content
    const pdfContainer = document.createElement("div");
    pdfContainer.appendChild(railsClone);
    pdfContainer.appendChild(pickListClone);

    // Export to PDF
    html2pdf(pdfContainer, {
        margin: 10,
        filename: "buildsheet.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { 
            scale: 2, 
            width: 1100,
            useCORS: true 
        },
        jsPDF: { 
            unit: "mm", 
            format: [279.4, 431.8], 
            orientation: "portrait" 
        },
    });
}
        generateRails();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>

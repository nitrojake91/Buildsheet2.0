<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox Parts Placement</title>
    <!-- Include html2canvas and jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
/* Modern Font */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #1e1e1e;
            color: #f8f9fa;
        }

        /* Tab Styling */
        .tab {
            overflow: hidden;
            background-color: #2c3e50;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab button {
            background-color: inherit;
            color: white;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            transition: 0.3s;
            font-size: 16px;
            font-weight: 500;
        }

        .tab button:hover {
            background-color: #34495e;
        }

        .tab button.active {
            background-color: #1abc9c;
        }

        /* Tab Content */
        .tabcontent {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .dark-mode .tabcontent {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        /* Container and Parts List */
        .container {
            display: flex;
            gap: 20px;
        }

        .parts-list {
            width: 220px;
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .parts-list {
            background-color: #34495e;
        }

        .button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #2980b9;
        }

        /* Sandbox Area */
        .sandbox {
            flex-grow: 1;
            position: relative;
            height: 100vh; /* Adjust based on viewport height */
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: auto; /* Enable scrolling */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform-origin: top left;
            transition: transform 0.2s ease;
        }

        .dark-mode .sandbox {
            background-color: #2c3e50;
            border-color: #34495e;
        }

        .rail-container {
            position: relative;
            width: 900px;
            height: 900px;
            transform-origin: top left;
            transform: scale(0.5); /* Initial scale */
        }

        .rail {
            position: absolute;
            width: 1800px;
            height: 100px;
            background-color: #A9A9A9;
            border: 1px solid #FF0000;
            border-radius: 6px;
        }

        .dark-mode .rail {
            background-color: #34495e;
            border-color: #2c3e50;
        }

        /* Part Styling */
        .part {
            position: absolute;
            color: white;
            text-align: center;
            line-height: 140px;
            font-size: 14px;
            cursor: move;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .part:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .part.NET {
            background-color: #9b59b6;
        }

        .part.LINK {
            background-color: #e67e22;
        }

        .part.PSU {
            background-color: #e67e22;
            background-image: linear-gradient(45deg, #95a5a6 25%, transparent 25%, transparent 50%, #95a5a6 50%, #95a5a6 75%, transparent 75%, transparent);
            background-size: 20px 20px;
        }

        .part.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .part.highlighted {
            border: 2px solid #1abc9c;
        }

        /* Dropdown Styling */
        .dropdown-container {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
        }

        .dropdown {
            width: 120px;
            padding: 3px;
            border-radius: 10px;
            border: 1px solid #bdc3c7;
            background-color: #fff;
            font-size: 30px;
            color: #000;
        }

        .dark-mode .dropdown {
    background-color: #34495e;
    border-color: #2c3e50;
    color: #f8f9fa; /* This makes the text white */
}


        /* Loading Popup */
        .loading-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .dark-mode .loading-popup {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        .loading-popup img {
            width: 100px;
            height: auto;
        }

        .loading-popup p {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }

        .dark-mode .loading-popup p {
            color: #f8f9fa;
        }

        /* Table Styling */
        .chart-table, .pick-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .chart-table, .dark-mode .pick-list-table {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        .chart-table th, .chart-table td, .pick-list-table th, .pick-list-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .dark-mode .chart-table th, .dark-mode .chart-table td, .dark-mode .pick-list-table th, .dark-mode .pick-list-table td {
            border-color: #34495e;
        }

        .chart-table th, .pick-list-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        .dark-mode .chart-table th, .dark-mode .pick-list-table th {
            background-color: #1abc9c;
        }

        .chart-table td, .pick-list-table td {
            background-color: #f8f9fa;
        }

        .dark-mode .chart-table td, .dark-mode .pick-list-table td {
            background-color: #34495e;
        }

        /* Total Row */
        .total-row {
            font-weight: bold;
            background-color: #1abc9c;
            color: white;
        }

        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
        }

        .dark-mode .popup {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        .popup button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .popup button:hover {
            background-color: #2980b9;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .dark-mode-toggle:fixed {
            background-color: #2980b9;
        }

        /* Part History */
        .part-history {
            position: hover;
            bottom: 20px;
            left: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dark-mode .part-history {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        .part-history h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        .part-history ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .part-history li {
            font-size: 14px;
            margin-bottom: 5px;
        }

        /* Custom Part Modal */
        .custom-part-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .dark-mode .custom-part-modal {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        .custom-part-modal h2 {
            margin: 0 0 20px;
            font-size: 18px;
        }

        .custom-part-modal label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .custom-part-modal input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .dark-mode .custom-part-modal input {
            background-color: #34495e;
            border-color: #2c3e50;
            color: #f8f9fa;
        }

        .custom-part-modal button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .custom-part-modal button:hover {
            background-color: #2980b9;
        }

        /* Part Templates */
        .part-templates {
            margin-top: 20px;
        }

        .part-templates h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        .part-templates ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .part-templates li {
            font-size: 14px;
            margin-bottom: 5px;
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
        }

        .dark-mode .part-templates li {
            color: #1abc9c;
        }

        /* Part Grouping */
        .part-group {
            border: 2px dashed #1abc9c;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .dark-mode .part-group {
            border-color: #3498db;
        }

        /* Part Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .part {
            animation: fadeIn 0.3s ease;
        }

        /* Polyline Styling */
        .polyline {
            stroke: black; /* Black line */
            stroke-width: 2;
            fill: none;
        }

        /* Ensure SVG is on top of parts */
        #polyline-svg {
            z-index: 10; /* Bring SVG to the top */
            pointer-events: none; /* Allow clicks to pass through to parts */
        }

        /* Complete Buildsheet Styling */
        #CompleteBuildsheet {
            text-align: center;
        }

        #buildsheet-content {
            margin-top: 20px;
        }

        #buildsheet-content img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #buildsheet-content table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark-mode #buildsheet-content table {
            background-color: #2c3e50;
            color: #f8f9fa;
        }

        #buildsheet-content th, #buildsheet-content td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .dark-mode #buildsheet-content th, .dark-mode #buildsheet-content td {
            border-color: #34495e;
        }

        #buildsheet-content th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        .dark-mode #buildsheet-content th {
            background-color: #1abc9c;
        }

        #buildsheet-content td {
            background-color: #f8f9fa;
        }

        .dark-mode #buildsheet-content td {
            background-color: #34495e;
        }

    </style>
</head>
<body>

<!-- Dark Mode Toggle -->
<button class="dark-mode-toggle" onclick="toggleDarkMode()">Toggle Dark Mode</button>

<!-- Popup -->
<div class="popup" id="popup">
    <p>Code Created by Jake Skidmore. This tool is a beta version not meant for design use. This program was developed using only information from Crestron's website and does not contain any Crestron IP.</p>
    <button onclick="closePopup()">Confirm</button>
</div>

<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Sandbox')" id="defaultOpen">Sandbox</button>
    <button class="tablinks" onclick="openTab(event, 'Chart')">Chart</button>
    <button class="tablinks" onclick="openTab(event, 'PickList')">Pick List</button>
    <button class="tablinks" onclick="openTab(event, 'CompleteBuildsheet')">Complete Buildsheet</button>
</div>

<div id="Sandbox" class="tabcontent">
    <h1>Parts List</h1>
    <!-- Panel Selection Dropdown -->
    <label for="panel-select">Select Panel:</label>
    <select id="panel-select" onchange="updatePanel()">
        <option value="" disabled selected>Select a panel</option>
        <option value="DIN-EN-2x18">DIN-EN-2x18 (2 rails)</option>
        <option value="DIN-EN-3x18">DIN-EN-3x18 (3 rails)</option>
        <option value="DIN-EN-6x18">DIN-EN-6x18 (6 rails)</option>
        <option value="DIN-EN-10x18">DIN-EN-10x18 (10 rails)</option>
    </select>
    <div class="container">
        <div class="parts-list">
            <button class="button" onclick="addPart('NET', 400, 160)">Add NET</button>
            <button class="button" onclick="addPart('PSU', 400, 160)">Add PSU</button>
            <button class="button" onclick="addPart('LINK', 300, 160)">Add LINK</button>
            <button class="button" onclick="nextRail()">Next Rail</button>
            <button class="button" onclick="removeLastPart()">Remove Last Part</button>
            <button class="button" onclick="addRail()">Add Rail</button>
            <button class="button" onclick="saveConfiguration()">Save Configuration</button>
            <button class="button" onclick="loadConfiguration()">Load Configuration</button>
            <button class="button" onclick="exportAsImage()">Export as Image</button>
            <button class="button" onclick="exportAsPDF()">Export as PDF</button>
            <button class="button" onclick="toggleSnapToGrid()">Toggle Snap-to-Grid</button>
            <button class="button" onclick="undo()">Undo</button>
            <button class="button" onclick="redo()">Redo</button>
        </div>

        <div class="sandbox" id="sandbox">
            <div class="rail-container" id="rail-container">
                <!-- Rails will be added here -->
            </div>
            <svg id="polyline-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></svg>
        </div>
    </div>
</div>

<div id="Chart" class="tabcontent">
    <h1>Chart</h1>
    <button class="button" onclick="generateChart()">Generate Chart</button>
    <table class="chart-table" id="chart-table">
        <thead>
            <tr>
                <th>Space</th>
                <th>Net Device</th>
                <th>Link Devices</th>
                <th>Power Consumption</th>
                <th>Device mA</th>
                <th>Total Space mA</th>
                <th>Calculate</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically added here -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="5"><strong>Total</strong></td>
                <td id="total-space-ma">0</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>

<div id="PickList" class="tabcontent">
    <h1>Pick List</h1>
    <button class="button" onclick="generatePickList()">Generate List</button>
    <table class="pick-list-table" id="pick-list-table">
        <thead>
            <tr>
                <th>Part Name</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>
</div>

<div id="CompleteBuildsheet" class="tabcontent">
    <h1>Complete Buildsheet</h1>
    <button class="button" onclick="generateBuildsheet()">Generate Buildsheet</button>
    <button class="button" onclick="exportBuildsheetToPDF()">Export to PDF</button>
    <div id="buildsheet-content">
        <!-- Content will be dynamically added here -->
    </div>
</div>

<!-- Loading Popup -->
<div class="loading-popup" id="loadingPopup">
    <p>Loading...</p>
</div>

<!-- Part History -->
<div class="part-history">
    <h3>Part History</h3>
    <ul id="part-history-list"></ul>
</div>

<!-- Custom Part Modal -->
<div class="custom-part-modal" id="customPartModal">
    <h2>Create Custom Part</h2>
    <label for="partName">Part Name:</label>
    <input type="text" id="partName" placeholder="Enter part name">
    <label for="partWidth">Width:</label>
    <input type="number" id="partWidth" placeholder="Enter width">
    <label for="partHeight">Height:</label>
    <input type="number" id="partHeight" placeholder="Enter height">
    <button onclick="createCustomPart()">Create</button>
    <button onclick="closeCustomPartModal()">Cancel</button>
</div>

<!-- Part Templates -->
<div class="part-templates">
    <h3>Part Templates</h3>
    <ul id="part-templates-list"></ul>
</div>

<script>
    const sandbox = document.getElementById("sandbox");
    const railContainer = document.getElementById("rail-container");
    const chartTableBody = document.querySelector("#chart-table tbody");
    const pickListTableBody = document.querySelector("#pick-list-table tbody");
    const loadingPopup = document.getElementById("loadingPopup");
    const popup = document.getElementById("popup");
    const totalSpaceMaCell = document.getElementById("total-space-ma");
    const partHistoryList = document.getElementById("part-history-list");
    const customPartModal = document.getElementById("customPartModal");
    const partTemplatesList = document.getElementById("part-templates-list");
    const polylineSvg = document.getElementById("polyline-svg");
    const panelSelect = document.getElementById("panel-select");
    const buildsheetContent = document.getElementById("buildsheet-content");

    let currentRailIndex = 0;
    let railPositions = [];
    let railWidths = [];
    let partPositions = [];
    let deletedRails = [];
    let parts = []; // Track all parts for the chart
    let currentLNumber = 1; // Track the current L number for NET and LINK parts
    let deviceMaValues = {}; // Store Device mA values
    let actionStack = []; // For undo/redo functionality
    let redoStack = []; // For undo/redo functionality
    let isSnapToGridEnabled = false; // Snap-to-grid feature
    let isDarkMode = false; // Dark mode state
    let isDrawingPolyline = false; // Polyline drawing state
    let selectedPart = null; // Track the first selected part for polyline drawing
    let maxRails = 0; // Start with 0 rails
    let isPSUOverride = false; // Track if the PSU warning has been overridden

    // Panel limits
    const panelLimits = {
        "DIN-EN-2x18": 2,
        "DIN-EN-3x18": 3,
        "DIN-EN-6x18": 6,
        "DIN-EN-10x18": 10
    };

    // Show popup on page load
    window.onload = () => {
        popup.style.display = "block";
        createRails();
        adjustScale();
    };

    // Adjust scale based on viewport size
    function adjustScale() {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const railContainerWidth = 1800;
        const railContainerHeight = 2000;

        // Calculate the scale factor to fit the rails within the viewport
        const scaleX = viewportWidth / railContainerWidth;
        const scaleY = viewportHeight / railContainerHeight;
        scale = Math.min(scaleX, scaleY) * 0.9; // 90% of the maximum scale to add some padding

        // Apply the scale to the rail container
        railContainer.style.transform = `scale(${scale})`;
    }

    // Resize event listener to adjust scale dynamically
    window.addEventListener("resize", adjustScale);

    // Zoom functionality
    function zoom(event) {
        if (event.ctrlKey) {
            event.preventDefault(); // Prevent default scroll behavior
            if (event.deltaY < 0) {
                // Zoom in
                scale = Math.min(scale + zoomFactor, maxScale);
            } else {
                // Zoom out
                scale = Math.max(scale - zoomFactor, minScale);
            }
            railContainer.style.transform = `scale(${scale})`;
        }
    }

    // Add zoom event listener
    window.addEventListener("wheel", zoom, { passive: false });

    // Touch gestures for pinch-to-zoom
    let initialDistance = null;

    function handleTouchStart(event) {
        if (event.touches.length === 2) {
            // Calculate the initial distance between two fingers
            initialDistance = Math.hypot(
                event.touches[0].clientX - event.touches[1].clientX,
                event.touches[0].clientY - event.touches[1].clientY
            );
        }
    }

    function handleTouchMove(event) {
        if (event.touches.length === 2) {
            // Calculate the current distance between two fingers
            const currentDistance = Math.hypot(
                event.touches[0].clientX - event.touches[1].clientX,
                event.touches[0].clientY - event.touches[1].clientY
            );

            // Calculate the scale factor
            if (initialDistance !== null) {
                const newScale = scale * (currentDistance / initialDistance);
                scale = Math.min(Math.max(newScale, minScale), maxScale);
                railContainer.style.transform = `scale(${scale})`;
            }
        }
    }

    function handleTouchEnd() {
        initialDistance = null;
    }

    // Add touch event listeners
    window.addEventListener("touchstart", handleTouchStart);
    window.addEventListener("touchmove", handleTouchMove);
    window.addEventListener("touchend", handleTouchEnd);

    // Close popup
    function closePopup() {
        popup.style.display = "none";
    }

    // Create Rails
    function createRails() {
        railContainer.innerHTML = ""; // Clear existing rails
        railPositions = [];
        railWidths = [];
        partPositions = [];

        for (let i = 0; i < maxRails; i++) {
            let rail = document.createElement("div");
            rail.className = "rail";
            rail.style.top = `${100 + i * 200}px`;
            rail.id = `rail-${i}`;

            let deleteButton = document.createElement("button");
            deleteButton.className = "delete-rail-button";
            deleteButton.textContent = "Delete Rail";
            deleteButton.onclick = () => deleteRail(i);
            rail.appendChild(deleteButton);

            railContainer.appendChild(rail);
            railPositions.push(100 + i * 200);
            railWidths.push(0);
            partPositions.push([]);
        }
    }

    // Update Panel
    function updatePanel() {
        const selectedPanel = panelSelect.value;
        if (!selectedPanel) {
            alert("Please select a panel first!");
            return;
        }
        maxRails = panelLimits[selectedPanel];

        // Recreate rails based on the new limit
        createRails();
    }

    // Add Rail
    function addRail() {
        const selectedPanel = panelSelect.value;
        if (!selectedPanel) {
            alert("Please select a panel first!");
            return;
        }
        const maxRailsForPanel = panelLimits[selectedPanel];

        if (railPositions.length >= maxRailsForPanel) {
            alert(`Cannot add more rails. The selected panel (${selectedPanel}) only supports ${maxRailsForPanel} rails.`);
            return;
        }

        // Create a new rail
        const newRailIndex = railPositions.length;
        const newRailTop = 100 + newRailIndex * 200;

        let rail = document.createElement("div");
        rail.className = "rail";
        rail.style.top = `${newRailTop}px`;
        rail.id = `rail-${newRailIndex}`;

        let deleteButton = document.createElement("button");
        deleteButton.className = "delete-rail-button";
        deleteButton.textContent = "Delete Rail";
        deleteButton.onclick = () => deleteRail(newRailIndex);
        rail.appendChild(deleteButton);

        railContainer.appendChild(rail);

        // Update the state
        railPositions.push(newRailTop);
        railWidths.push(0);
        partPositions.push([]);

        // Add to action stack for undo/redo
        actionStack.push({ type: "addRail", railIndex: newRailIndex });
        redoStack = []; // Clear redo stack
        updatePartHistory(`Added rail ${newRailIndex}`);
    }

    // Add Part
    function addPart(type, width, height) {
        const selectedPanel = panelSelect.value;
        if (!selectedPanel) {
            alert("Please select a panel first!");
            return;
        }

        // Check if the first part is not a PSU
        if (parts.length === 0 && type !== "PSU" && !isPSUOverride) {
            const confirmOverride = confirm("Panels require at least 1 PSU. Do you want to override this requirement?");
            if (!confirmOverride) {
                return;
            } else {
                isPSUOverride = true; // Prevent the popup from showing again
            }
        }

        if (currentRailIndex >= maxRails) {
            alert(`Cannot add more rails. The selected panel (${selectedPanel}) only supports ${maxRails} rails.`);
            return;
        }

        if (!railWidths[currentRailIndex]) railWidths[currentRailIndex] = 0;
        if (!partPositions[currentRailIndex]) partPositions[currentRailIndex] = [];

        let availableWidth = railWidths[currentRailIndex];

        if (availableWidth + width > 1800) {
            alert("Not enough space on this rail!");
            return;
        }

        let part = document.createElement("div");
        part.className = `part ${type}`;
        part.style.width = `${width}px`;
        part.style.height = `${height}px`;

        // Place the part 30% higher on the rail
        const railTop = railPositions[currentRailIndex];
        part.style.top = `${railTop - height * 0.3}px`; // 30% higher
        part.style.left = `${availableWidth}px`;

        // Make the part draggable
        part.draggable = true;
        part.addEventListener("dragstart", dragStart);
        part.addEventListener("dragend", dragEnd);

        // Left Dropdown Container
        let leftContainer = document.createElement("div");
        leftContainer.className = "dropdown-container";
        leftContainer.appendChild(createDropdown(type, getLeftOptions(type)));

        // Center Dropdown Container (Only for NET and PSU)
        let centerContainer = document.createElement("div");
        centerContainer.className = "dropdown-container";
        if (type !== "LINK") {
            centerContainer.appendChild(createDropdown(type, getCenterOptions(type)));
            centerContainer.appendChild(createDropdown(type, getCenterOptions(type)));
        }

        // Right Dropdown Container
        let rightContainer = document.createElement("div");
        rightContainer.className = "dropdown-container";
        rightContainer.appendChild(createDropdown(type, getRightOptions(type)));
        rightContainer.appendChild(createDropdown(type, getRightOptions(type)));

        part.appendChild(leftContainer);
        part.appendChild(centerContainer);
        part.appendChild(rightContainer);

        railContainer.appendChild(part);

        railWidths[currentRailIndex] += width;
        partPositions[currentRailIndex].push(part);

        // Track the part for the chart
        parts.push({ type, element: part });

        // Update L number for NET and LINK parts
        if (type === "NET") {
            // Set the L number for the NET part
            const dropdowns = part.querySelectorAll(".dropdown");
            dropdowns.forEach((dropdown, index) => {
                if (index > 0) { // Skip the first dropdown (NET type)
                    dropdown.value = `L${currentLNumber}`;
                }
            });
            currentLNumber++; // Increment L number for the next NET
        } else if (type === "LINK") {
            // Set the L number for the LINK part to match the most recent NET
            const dropdowns = part.querySelectorAll(".dropdown");
            dropdowns.forEach((dropdown) => {
                dropdown.value = `L${currentLNumber - 1}`; // Use the current L number
            });
        }

        // Add to action stack for undo/redo
        actionStack.push({ type: "add", part });
        redoStack = []; // Clear redo stack
        updatePartHistory(`Added ${type} part`);
    }

    // Drag and Drop Functions
    let draggedPart = null;

    function dragStart(event) {
        draggedPart = event.target;
        event.dataTransfer.setData("text/plain", ""); // Required for Firefox
        setTimeout(() => {
            draggedPart.style.opacity = "0.4";
        }, 0);
    }

    function dragEnd(event) {
        draggedPart.style.opacity = "1";
        draggedPart = null;
    }

    railContainer.addEventListener("dragover", (event) => {
        event.preventDefault();
    });

    railContainer.addEventListener("drop", (event) => {
        event.preventDefault();
        if (draggedPart) {
            // Calculate new position
            const rect = railContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Snap to the nearest rail
            const railIndex = Math.floor((y - 100) / 200); // Calculate which rail the part is on
            if (railIndex >= 0 && railIndex < maxRails) {
                const railTop = railPositions[railIndex];
                const railBottom = railTop + 100; // Rail height is 100px

                // Ensure the part stays within the rail's width
                const maxLeft = 1800 - draggedPart.offsetWidth;
                const snappedLeft = Math.max(0, Math.min(x - draggedPart.offsetWidth / 2, maxLeft));

                // Snap the part to the rail
                draggedPart.style.left = `${snappedLeft}px`;
                draggedPart.style.top = `${railTop - draggedPart.offsetHeight * 0.3}px`; // 30% higher
            }
        }
    });

    // Generate Chart
    function generateChart() {
        console.log("Generating chart..."); // Debugging

        // Show loading popup
        loadingPopup.style.display = "block";

        // Simulate loading delay
        setTimeout(() => {
            loadingPopup.style.display = "none";
            chartTableBody.innerHTML = ""; // Clear the table
            let netIndex = 0;
            let totalSpaceMa = 0; // Initialize total

        // Define power consumption values
        const powerValues = {
            NET: { LV: 120, DLI: 80 },
            LINK: { LV: 100, DIMU: 100, SW: 50, PLUG: 50, IO: 145 }
        };

        parts.forEach((part, index) => {
            if (part.type === "NET") {
                let netDevice = part.element.querySelector(".dropdown").value;
                let linkDevices = [];
                let rowPower = 0;

                // Add power consumption for the NET device
                rowPower += powerValues.NET[netDevice] || 0;

                let nextNetIndex = parts.findIndex((p, i) => i > index && p.type === "NET");

                // Collect LINK devices between this NET and the next NET
                for (let i = index + 1; i < (nextNetIndex !== -1 ? nextNetIndex : parts.length); i++) {
                    if (parts[i].type === "LINK") {
                        let linkDevice = parts[i].element.querySelector(".dropdown").value;
                        linkDevices.push(linkDevice);
                        // Add power consumption for the LINK device
                        rowPower += powerValues.LINK[linkDevice] || 0;
                    }
                }

                // Add a row to the chart
                let row = document.createElement("tr");

                // Space (editable)
                let spaceCell = document.createElement("td");
                let spaceInput = document.createElement("input");
                spaceInput.type = "text";
                spaceInput.value = `Space ${netIndex + 1}`;
                spaceCell.appendChild(spaceInput);
                row.appendChild(spaceCell);

                // Net Device
                let netDeviceCell = document.createElement("td");
                netDeviceCell.textContent = netDevice;
                row.appendChild(netDeviceCell);

                // Link Devices
                let linkDevicesCell = document.createElement("td");
                linkDevicesCell.textContent = linkDevices.join(", ");
                row.appendChild(linkDevicesCell);

                // Power Consumption (row total)
                let powerCell = document.createElement("td");
                let powerInput = document.createElement("input");
                powerInput.type = "text";
                powerInput.value = rowPower; // Set the row's power consumption
                powerInput.readOnly = true; // Make it read-only
                powerCell.appendChild(powerInput);
                row.appendChild(powerCell);

                // Device mA (editable)
                let deviceMaCell = document.createElement("td");
                let deviceMaInput = document.createElement("input");
                deviceMaInput.type = "number";
                deviceMaInput.value = deviceMaValues[netIndex] || "0"; // Preserve Device mA value
                deviceMaInput.oninput = () => {
                    // Ensure only numbers are entered
                    deviceMaInput.value = deviceMaInput.value.replace(/[^0-9]/g, "");
                    deviceMaValues[netIndex] = deviceMaInput.value; // Store Device mA value
                };
                deviceMaCell.appendChild(deviceMaInput);
                row.appendChild(deviceMaCell);

                // Total Space mA (read-only)
                let totalSpaceMaCell = document.createElement("td");
                let totalSpaceMaInput = document.createElement("input");
                totalSpaceMaInput.type = "text";
                totalSpaceMaInput.readOnly = true;
                totalSpaceMaInput.value = "0"; // Initialize to 0
                totalSpaceMaCell.appendChild(totalSpaceMaInput);
                row.appendChild(totalSpaceMaCell);

                // Calculate button
                let calculateCell = document.createElement("td");
                let calculateButton = document.createElement("button");
                calculateButton.textContent = "Calculate";
                calculateButton.onclick = () => {
                    const powerConsumption = parseFloat(powerInput.value) || 0;
                    const deviceMa = parseFloat(deviceMaInput.value) || 0;
                    const totalSpaceMa = powerConsumption + deviceMa;
                    totalSpaceMaInput.value = totalSpaceMa; // Update Total Space mA
                    updateTotal(); // Update the total
                };
                calculateCell.appendChild(calculateButton);
                row.appendChild(calculateCell);

                chartTableBody.appendChild(row);
                netIndex++;
            }
        });

        // Show the chart table
        document.getElementById("chart-table").style.display = "table";
    }, 2000); // Simulate a 2-second loading delay
}

// Update Total
function updateTotal() {
    let total = 0;
    const rows = chartTableBody.querySelectorAll("tr");
    rows.forEach(row => {
        const totalSpaceMaInput = row.querySelector("td:nth-child(6) input");
        if (totalSpaceMaInput) {
            total += parseFloat(totalSpaceMaInput.value) || 0;
        }
    });
    totalSpaceMaCell.textContent = total; // Update the total cell
}

// Generate Pick List
function generatePickList() {
    pickListTableBody.innerHTML = ""; // Clear the table

    // Check if all NET and LINK devices have a type selected
    let hasError = false;
    parts.forEach(part => {
        if (part.type === "NET" || part.type === "LINK") {
            const dropdown = part.element.querySelector(".dropdown");
            if (!dropdown.value) {
                hasError = true;
                alert(`Error: ${part.type} device does not have a type selected.`);
            }
        }
    });

    if (hasError) {
        return;
    }

    // Add the selected panel to the pick list
    const selectedPanel = panelSelect.value;
    let row = document.createElement("tr");

    // Panel Name
    let panelNameCell = document.createElement("td");
    panelNameCell.textContent = selectedPanel;
    row.appendChild(panelNameCell);

    // Quantity
    let quantityCell = document.createElement("td");
    quantityCell.textContent = 1; // Only one panel
    row.appendChild(quantityCell);

    pickListTableBody.appendChild(row);

    // Count the number of each part type
    const partCounts = {};
    parts.forEach(part => {
        const partType = part.type;
        const partOption = part.element.querySelector(".dropdown").value;
        let partKey = `${partType}, ${partOption}`;

        // Handle PSU parts (PSU1 - PSU9)
        if (partType === "PSU" && partOption.startsWith("PSU")) {
            partKey = "PSU"; // Map all PSU1-PSU9 to "PSU"
        }

        // Map the part key to the corresponding part name
        const partNameMap = {
            "NET, LV": "ZUMNET-DIN-16A-LV",
            "NET, DLI": "ZUMNET-DIN-DLI",
            "LINK, LV": "ZUMLINK-DIN-16A-LV",
            "LINK, DIMU": "ZUMLINK-DIN-DIMU",
            "LINK, SW": "ZUMLINK-DIN-20A-SW",
            "LINK, PLUG": "ZUMLINK-DIN-20A-PLUG",
            "LINK, IO": "ZUMLINK-DIN-IO",
            "PSU": "ZUMLINK-DIN-PSU" // Map all PSU parts to ZUMLINK-DIN-PSU
        };

        const partName = partNameMap[partKey] || partType;

        partCounts[partName] = (partCounts[partName] || 0) + 1;
    });

    // Add rows to the pick list table
    for (const [partName, count] of Object.entries(partCounts)) {
        let row = document.createElement("tr");

        // Part Name
        let partNameCell = document.createElement("td");
        partNameCell.textContent = partName;
        row.appendChild(partNameCell);

        // Quantity
        let quantityCell = document.createElement("td");
        quantityCell.textContent = count;
        row.appendChild(quantityCell);

        pickListTableBody.appendChild(row);
    }

    // Show the pick list table
    document.getElementById("pick-list-table").style.display = "table";
}

// Next Rail
function nextRail() {
    if (currentRailIndex < maxRails - 1) {
        currentRailIndex++;
    } else {
        alert("No more rails left!");
    }
}

// Remove Last Part
function removeLastPart() {
    if (partPositions[currentRailIndex].length === 0) {
        if (currentRailIndex > 0) {
            currentRailIndex--;
        }
        return;
    }

    let lastPart = partPositions[currentRailIndex].pop();
    railWidths[currentRailIndex] -= lastPart.offsetWidth;
    railContainer.removeChild(lastPart);

    // Remove the part from the parts array
    parts = parts.filter(p => p.element !== lastPart);

    // Add to action stack for undo/redo
    actionStack.push({ type: "remove", part: lastPart });
    redoStack = []; // Clear redo stack
    updatePartHistory(`Removed ${lastPart.className.split(" ")[1]} part`);
}

// Delete Rail
function deleteRail(railIndex) {
    if (railIndex < 0 || railIndex >= railPositions.length) {
        alert("Invalid rail index!");
        return;
    }

    // Remove all parts on the rail
    partPositions[railIndex].forEach(part => railContainer.removeChild(part));
    partPositions[railIndex] = [];

    // Remove the rail from the DOM
    const rail = document.getElementById(`rail-${railIndex}`);
    if (rail) {
        railContainer.removeChild(rail);
    }

    // Update the state
    railPositions.splice(railIndex, 1);
    railWidths.splice(railIndex, 1);
    partPositions.splice(railIndex, 1);

    // Update the IDs of the remaining rails
    for (let i = railIndex; i < railPositions.length; i++) {
        const rail = document.getElementById(`rail-${i + 1}`);
        if (rail) {
            rail.id = `rail-${i}`;
            rail.style.top = `${100 + i * 200}px`; // Adjust the position
        }
    }

    // Add to action stack for undo/redo
    actionStack.push({ type: "deleteRail", railIndex });
    redoStack = []; // Clear redo stack
    updatePartHistory(`Deleted rail ${railIndex}`);
}

// Create Dropdown
function createDropdown(type, options) {
    let select = document.createElement("select");
    select.className = `dropdown ${type}`;
    options.forEach(option => {
        let opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    return select;
}

// Get Left Options
function getLeftOptions(type) {
    if (type === "NET") return ["LV", "DLI"];
    if (type === "LINK") return ["LV", "DIMU", "SW", "PLUG", "IO"];
    if (type === "PSU") return Array.from({ length: 9 }, (_, i) => `PSU${i + 1}`);
    return [];
}

// Get Center Options
function getCenterOptions(type) {
    if (type === "NET") return Array.from({ length: 99 }, (_, i) => `N${i + 1}`);
    if (type === "PSU") return Array.from({ length: 99 }, (_, i) => `L${i + 1}`);
    return [];
}

// Get Right Options
function getRightOptions(type) {
    return Array.from({ length: 99 }, (_, i) => `L${i + 1}`);
}

// Tab Functionality
function openTab(evt, tabName) {
    let tabcontent = document.getElementsByClassName("tabcontent");
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    let tablinks = document.getElementsByClassName("tablinks");
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

// Open the default tab on page load
document.getElementById("defaultOpen").click();

// Save Configuration
function saveConfiguration() {
    const configuration = {
        parts: parts.map(part => ({
            type: part.type,
            width: part.element.offsetWidth,
            height: part.element.offsetHeight,
            top: part.element.style.top,
            left: part.element.style.left
        })),
        railPositions,
        railWidths,
        partPositions,
        currentRailIndex,
        currentLNumber,
        deviceMaValues,
        selectedPanel: panelSelect.value
    };
    localStorage.setItem("sandboxConfiguration", JSON.stringify(configuration));
    alert("Configuration saved!");
}

// Load Configuration
function loadConfiguration() {
    const configuration = JSON.parse(localStorage.getItem("sandboxConfiguration"));
    if (!configuration) {
        alert("No saved configuration found!");
        return;
    }

    // Clear existing parts
    parts.forEach(part => railContainer.removeChild(part.element));
    parts = [];
    railPositions = configuration.railPositions;
    railWidths = configuration.railWidths;
    partPositions = configuration.partPositions;
    currentRailIndex = configuration.currentRailIndex;
    currentLNumber = configuration.currentLNumber;
    deviceMaValues = configuration.deviceMaValues;

    // Set the selected panel
    panelSelect.value = configuration.selectedPanel || "DIN-EN-10x18";
    updatePanel();

    // Recreate parts
    configuration.parts.forEach(partConfig => {
        const part = document.createElement("div");
        part.className = `part ${partConfig.type}`;
        part.style.width = `${partConfig.width}px`;
        part.style.height = `${partConfig.height}px`;
        part.style.top = partConfig.top;
        part.style.left = partConfig.left;

        // Make the part draggable
        part.draggable = true;
        part.addEventListener("dragstart", dragStart);
        part.addEventListener("dragend", dragEnd);

        // Left Dropdown Container
        let leftContainer = document.createElement("div");
        leftContainer.className = "dropdown-container";
        leftContainer.appendChild(createDropdown(partConfig.type, getLeftOptions(partConfig.type)));

        // Center Dropdown Container (Only for NET and PSU)
        let centerContainer = document.createElement("div");
        centerContainer.className = "dropdown-container";
        if (partConfig.type !== "LINK") {
            centerContainer.appendChild(createDropdown(partConfig.type, getCenterOptions(partConfig.type)));
            centerContainer.appendChild(createDropdown(partConfig.type, getCenterOptions(partConfig.type)));
        }

        // Right Dropdown Container
        let rightContainer = document.createElement("div");
        rightContainer.className = "dropdown-container";
        rightContainer.appendChild(createDropdown(partConfig.type, getRightOptions(partConfig.type)));
        rightContainer.appendChild(createDropdown(partConfig.type, getRightOptions(partConfig.type)));

        part.appendChild(leftContainer);
        part.appendChild(centerContainer);
        part.appendChild(rightContainer);

        railContainer.appendChild(part);
        parts.push({ type: partConfig.type, element: part });
    });

    alert("Configuration loaded!");
}

// Export as Image
function exportAsImage() {
    html2canvas(sandbox).then(canvas => {
        const link = document.createElement("a");
        link.download = "sandbox.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}

// Export as PDF
function exportAsPDF() {
    html2canvas(sandbox).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF();
        pdf.addImage(imgData, "PNG", 10, 10);
        pdf.save("sandbox.pdf");
    });
}

// Open Custom Part Modal
function openCustomPartModal() {
    customPartModal.style.display = "block";
}

// Close Custom Part Modal
function closeCustomPartModal() {
    customPartModal.style.display = "none";
}

// Create Custom Part
function createCustomPart() {
    const partName = document.getElementById("partName").value;
    const partWidth = parseInt(document.getElementById("partWidth").value);
    const partHeight = parseInt(document.getElementById("partHeight").value);

    if (!partName || !partWidth || !partHeight) {
        alert("Please fill in all fields!");
        return;
    }

    addPart(partName, partWidth, partHeight);
    closeCustomPartModal();
}

// Toggle Snap-to-Grid
function toggleSnapToGrid() {
    isSnapToGridEnabled = !isSnapToGridEnabled;
    alert(`Snap-to-Grid ${isSnapToGridEnabled ? "Enabled" : "Disabled"}`);
}

// Undo
function undo() {
    if (actionStack.length === 0) {
        alert("Nothing to undo!");
        return;
    }

    const lastAction = actionStack.pop();
    redoStack.push(lastAction);

    switch (lastAction.type) {
        case "add":
            railContainer.removeChild(lastAction.part);
            parts = parts.filter(p => p.element !== lastAction.part);
            break;
        case "remove":
            railContainer.appendChild(lastAction.part);
            parts.push({ type: lastAction.part.className.split(" ")[1], element: lastAction.part });
            break;
        case "deleteRail":
            readdRail();
            break;
        case "addRail":
            deleteRail(lastAction.railIndex);
            break;
    }

    updatePartHistory(`Undo: ${lastAction.type}`);
}

// Redo
function redo() {
    if (redoStack.length === 0) {
        alert("Nothing to redo!");
        return;
    }

    const lastAction = redoStack.pop();
    actionStack.push(lastAction);

    switch (lastAction.type) {
        case "add":
            railContainer.appendChild(lastAction.part);
            parts.push({ type: lastAction.part.className.split(" ")[1], element: lastAction.part });
            break;
        case "remove":
            railContainer.removeChild(lastAction.part);
            parts = parts.filter(p => p.element !== lastAction.part);
            break;
        case "deleteRail":
            deleteRail(lastAction.railIndex);
            break;
        case "addRail":
            addRail();
            break;
    }

    updatePartHistory(`Redo: ${lastAction.type}`);
}

// Update Part History
function updatePartHistory(action) {
    const historyItem = document.createElement("li");
    historyItem.textContent = action;
    partHistoryList.appendChild(historyItem);
}

// Toggle Dark Mode
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle("dark-mode", isDarkMode);
}
     // Generate Buildsheet
    function generateBuildsheet() {
    const buildsheetContent = document.getElementById("buildsheet-content");
    buildsheetContent.innerHTML = ""; // Clear previous content

    const sandbox = document.getElementById("sandbox");

    // Clone the sandbox to capture hidden elements
    const clonedSandbox = sandbox.cloneNode(true);
    clonedSandbox.style.position = "absolute";
    clonedSandbox.style.left = "-9999px"; // Move off-screen
    clonedSandbox.style.display = "block";
    clonedSandbox.style.backgroundColor = "#fff"; // Ensure solid background
    document.body.appendChild(clonedSandbox);

    // Ensure all parts have a solid background color
    const parts = clonedSandbox.querySelectorAll(".part");
    parts.forEach(part => {
        const computedStyle = window.getComputedStyle(part);
        part.style.backgroundColor = computedStyle.backgroundColor !== "transparent" ? computedStyle.backgroundColor : "#ccc"; // Default to gray
    });

    // Replace all dropdowns with static text
    const originalDropdowns = sandbox.querySelectorAll("select");
    const clonedDropdowns = clonedSandbox.querySelectorAll("select");
    clonedDropdowns.forEach((clonedSelect, index) => {
        if (originalDropdowns[index]) {
            const selectedText = originalDropdowns[index].options[originalDropdowns[index].selectedIndex].text;
            const span = document.createElement("span");
            span.textContent = selectedText;
            span.style.fontFamily = window.getComputedStyle(originalDropdowns[index]).fontFamily;
            span.style.fontSize = "45px";
            span.style.textAlign = "center";
            span.style.display = "inline-block";
            span.style.width = clonedSelect.offsetWidth + "px";
            span.style.height = clonedSelect.offsetHeight + "px";
            span.style.lineHeight = clonedSelect.offsetHeight + "px";
            clonedSelect.parentNode.replaceChild(span, clonedSelect);
        }
    });

    setTimeout(() => {
        html2canvas(clonedSandbox, {
            scrollX: 0,
            scrollY: 0,
            width: clonedSandbox.scrollWidth,
            height: clonedSandbox.scrollHeight,
            useCORS: true,
            allowTaint: true,
            backgroundColor: "#fff", // Ensure solid white background
            scale: 2
        }).then((canvas) => {
            document.body.removeChild(clonedSandbox); // Remove cloned sandbox

            const sandboxImage = document.createElement("img");
            sandboxImage.src = canvas.toDataURL("image/png");
            sandboxImage.style.maxWidth = "100%";
            sandboxImage.style.height = "auto";
            buildsheetContent.appendChild(sandboxImage);

            const pickListTable = document.getElementById("pick-list-table").cloneNode(true);
            buildsheetContent.appendChild(pickListTable);
        }).catch((error) => {
            console.error("Error capturing sandbox:", error);
            const errorMessage = document.createElement("p");
            errorMessage.textContent = "Failed to generate buildsheet. Please try again.";
            errorMessage.style.color = "red";
            buildsheetContent.appendChild(errorMessage);
        });
    }, 1500);
}
    // Export Buildsheet to PDF
    function exportBuildsheetToPDF() {
        const { jsPDF } = window.jspdf; // Initialize jsPDF
        const buildsheetContent = document.getElementById("buildsheet-content");

        html2canvas(buildsheetContent, {
            scrollX: 0,
            scrollY: 0,
            windowWidth: buildsheetContent.scrollWidth,
            windowHeight: buildsheetContent.scrollHeight,
            logging: true,
            useCORS: true,
            allowTaint: true,
        }).then((canvas) => {
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4"); // A4 size
            const imgWidth = 190; // Max width for A4
            const imgHeight = (canvas.height * imgWidth) / canvas.width; // Maintain aspect ratio

            pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
            pdf.save("buildsheet.pdf");
        }).catch((error) => {
            console.error("Error exporting to PDF:", error);
        });
    }
</script>

</body>
</html>

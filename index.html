
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Panel and Parts Configuration</title>
  <style>
    /* Full CSS */
   :root {
  --primary-color: #003366;
  --secondary-color: #0099CC;
  --accent-color: #FF6600;
  --background-color: #F5F5F5;
  --text-color: #333333;
  --button-gradient: linear-gradient(135deg, #0099CC, #003366);
  --button-hover-gradient: linear-gradient(135deg, #0077B3, #002244);
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
  --glow: 0 0 10px rgba(255, 255, 255, 0.8);
}

/* Preloader Styles */
#preloader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: black;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Courier New', Courier, monospace;
  font-size: 2rem;
  z-index: 1000;
  opacity: 1;
  transition: opacity 1s ease-in-out;
}

#preloader.hidden {
  opacity: 0;
  pointer-events: none;
}

#preloader-text {
  white-space: nowrap;
  overflow: hidden;
  color: green;
  border-right: 2px solid black;
}

@keyframes blink-caret {
  from, to { border-color: transparent; }
  50% { border-color: black; }
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px;
}

.container {
  width: 75%;
  min-width: 120px;
  background-color: white;
  border-radius: 30px;
  box-shadow: var(--shadow);
  overflow: auto;
  height: 2300px;
}

.tab-buttons {
  display: flex;
  gap: 10px;
  padding: 20px;
  background-color: var(--primary-color);
  border-radius: 12px 12px 0 0;
}

.tab-buttons button {
  padding: 10px 20px;
  background: var(--button-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.tab-buttons button:hover {
  background: var(--button-hover-gradient);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.tab-buttons button.active {
  background: var(--accent-color);
}

.tab {
  position: relative;
  display: none;
  padding: 20px;
  height: 100%;
  overflow: visible !important;
}

.tab.active {
  display: flex;
  gap: 20px;
}

.sidebar {
  width: 250px;
  background-color: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.sidebar button {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  background: var(--button-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.sidebar button:hover {
  background: var(--button-hover-gradient);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.panel-container {
  flex: 2;
  border-radius: 12px;

  border-color: black;
  position: relative;
  width: 100%;
  height: auto;
  overflow: visible;
}

.rail-graphic {
  position: absolute;
  background-color: var(--secondary-color);
  height: 18px;
  padding: 20px;
  width: 324px;
  border-radius: 4px;
  z-index: 1;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  left: 40px; /* Changed from 20px to 40px to move rails over by 20px */
}

.part {
  position: absolute;
  padding: 0px;
  background-color: var(--accent-color);
  background-size: 100% 100%;
  background-repeat: no-repeat;
  border: none;
  border-radius: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 10px;
  text-align: center;
  flex-direction: column;
  z-index: 2;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  cursor: grab;
  border: 2px solid rgba(255, 255, 255, 0.5);
  border-color: #000;
  overflow: auto;

}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.part .dots {
  display: flex;
  gap: 10px;
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
}

.part .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid black;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.part .data-indicator {
  position: absolute;
  top: 5px;
  left: 5px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: red;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.part .data-indicator.green {
  background-color: green;
}

.wiring-svg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: all;
  z-index: 1000;
}

#wiring-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.wiring-svg path {
  stroke-width: 18;
  fill: none;
  z-index: 1000;
}

.wire-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  z-index: 1000;
}

.wire-popup button {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  background: var(--button-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.wire-popup button:hover {
  background: var(--button-hover-gradient);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.space-layout,
.load-schedule {
  padding: 20px;
}

.space-layout h2,
.load-schedule h2 {
  margin-bottom: 20px;
}

.space-layout table,
.load-schedule table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.space-layout th,
.space-layout td,
.load-schedule th,
.load-schedule td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: left;
}

.space-layout th,
.load-schedule th {
  background-color: var(--primary-color);
  color: white;
}

.space-layout tr:nth-child(even),
.load-schedule tr:nth-child(even) {
  background-color: #f9f9f9;
}

.space-layout input[type="text"],
.space-layout input[type="number"] {
  width: 100%;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.nested-table {
  width: 100%;
  border-collapse: collapse;
}

.nested-table td {
  padding: 5px;
  border: 1px solid #ddd;
}

.non-editable {
  pointer-events: none;
  cursor: default;
}

.part:hover {
  box-shadow: var(--glow);
  transform: scale(1.05);
}

.tab-buttons button:hover {
  box-shadow: var(--glow);
}

.sidebar button:hover {
  box-shadow: var(--glow);
}

.rail-graphic:hover {
  box-shadow: var(--glow);
}

.part .data-indicator {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.part .dot {
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Part Data Popup Styles */
#part-popup {
  width: 300px;
  padding: 20px;
  background-color: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  display: none;
}

#part-popup h3 {
  margin-bottom: 15px;
  text-align: left;
}

#part-popup .form-row {
  display: flex;
  flex-direction: column;
  margin-bottom: 10px;
  text-align: left;
}

#part-popup .form-row label {
  margin-bottom: 5px;
  font-weight: 600;
}

#part-popup .form-row input {
  width: 100%;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#part-popup .form-row button {
  padding: 10px;
  margin: 5px 0;
  background: var(--button-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

#part-popup .form-row button:hover {
  background: var(--button-hover-gradient);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

/* Help Button */
.help-button {
  position: fixed;
  bottom: 100px;
  left: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary-color);
  color: white;
  border: none;
  font-size: 20px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  z-index: 1000;
}

.help-button:hover {
  background-color: var(--secondary-color);
  transform: scale(1.1);
}

/* Help Popup */
#help-popup {
  width: 400px;
  padding: 20px;
  background-color: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
}

.help-tab-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.help-tab-buttons button {
  padding: 10px 20px;
  background: var(--button-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.help-tab-buttons button.active {
  background: var(--accent-color);
}

.help-tab {
  display: none;
}

.help-tab.active {
  display: block;
}

#close-help-popup {
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#close-help-popup:hover {
  background: #cc0000;
}

/* Pick List Container */
.pick-list-container {
  width: 400px;
  background-color: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  position: absolute;
  top: 125px;
  left: 1200px;
}

.pick-list-container h3 {
  margin-bottom: 15px;
  text-align: center;
}

#pick-list-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

#pick-list-table th,
#pick-list-table td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: left;
}

#pick-list-table th {
  background-color: var(--primary-color);
  color: white;
}

#pick-list-table tr:nth-child(even) {
  background-color: #f9f9f9;
}

/* CRESTRON Container */
.crestron-container {
  width: 800px;
  background-color: white;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #ddd;
  border-color: black;
  box-shadow: var(--shadow);
  position: absolute;
  top: 900px;
  left: 1300px;
}

.crestron-header {
  text-align: center;
  margin-bottom: 20px;
}

.crestron-title {
  font-size: 24px;
  font-weight: bold;
}

.crestron-subtitle {
  font-size: 14px;
  margin-left: 10px;
}

.electrical-ratings-table,
.additional-ratings-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.additional-ratings-table td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: center;
}

.additional-ratings-table td[colspan] {
  font-size: 12px;
  font-style: italic;
}

.additional-ratings-table input {
  width: 50px;
  text-align: center;
}

/* New Updates for Fixed Positioning on Wiring Page */
#wiring-tab.active .pick-list-container,
#wiring-tab.active .crestron-container {
  position: fixed;
  z-index: 1000;
}

#wiring-tab.active .pick-list-container {
  top: 150px;
  left: 20px;
}

#wiring-tab.active .crestron-container {
  top: 400px;
  left: 20px;
}

/* Hide containers by default */
.pick-list-container,
.crestron-container {
  display: none;
}

/* Positioning for Pick List and CRESTRON Container on other tabs */
#main-tab.active .pick-list-container,
#space-tab.active .pick-list-container,
#load-tab.active .pick-list-container {
  position: absolute;
  top: 125px;
  left: 1200px;
}

#main-tab.active .crestron-container,
#space-tab.active .crestron-container,
#load-tab.active .crestron-container {
  position: absolute;
  top: 900px;
  left: 1300px;
}



  </style>
  </head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div id="preloader-text"></div>
  </div>

  <!-- Help Popup -->
  <div id="help-popup" class="wire-popup" style="display: none;">
    <div class="help-tab-buttons">
      <button id="page-info-tab-button" class="active">Page Info</button>
      <button id="faq-tab-button">FAQ</button>
    </div>
    <div id="page-info-tab" class="help-tab active">
      <p>This is the Page Info section. Add your page-specific information here.</p>
    </div>
    <div id="faq-tab" class="help-tab">
      <p>This is the FAQ section. Add your frequently asked questions here.</p>
    </div>
    <button id="close-help-popup" style="position: absolute; top: 10px; right: 10px;">×</button>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Tab Buttons -->
    <div class="tab-buttons">
      <button id="main-tab-button" data-tab="main-tab">Main Page</button>
      <button id="wiring-tab-button" data-tab="wiring-tab">Panel Wiring</button>
      <button id="space-tab-button" data-tab="space-tab">Space Layout</button>
      <button id="load-tab-button" data-tab="load-tab">Load Schedule</button>
      <button id="print-pdf-button">Print to PDF</button>
      <button id="save-button">Save</button>
      <button id="load-button">Load</button>
    </div>

    <!-- Main Page Tab -->
    <div id="main-tab" class="tab active">
      <div class="sidebar">
        <label for="panel-select">Panel Selection:</label>
        <select id="panel-select">
          <option value="DIN-EN-2X18">DIN-EN-2X18</option>
          <option value="DIN-EN-3X18">DIN-EN-3X18</option>
          <option value="DIN-EN-6X18">DIN-EN-6X18</option>
          <option value="DIN-EN-10X18">DIN-EN-10X18</option>
        </select>
        <button data-part="1MU">Add 1MU Spaceing</button>
        <button data-part="Terminal Block">Add Terminal Block</button>
        <button data-part="ZUMNET-DIN-DLI">Add ZUMNET-DIN-DLI</button>
        <button data-part="ZUMNET-DIN-16A-LV">Add ZUMNET-DIN-16A-LV</button>
        <button data-part="ZUMLINK-DIN-PSU">Add ZUMLINK-DIN-PSU</button>
        <button data-part="ZUMLINK-DIN-16A-LV">Add ZUMLINK-DIN-16A-LV</button>
        <button data-part="ZUMLINK-DIN-20A-SW">Add ZUMLINK-DIN-20A-SW</button>
        <button data-part="ZUMLINK-DIN-20A-PLUG">Add ZUMLINK-DIN-20A-PLUG</button>
        <button data-part="ZUMLINK-DIN-DIMU">Add ZUMLINK-DIN-DIMU</button>
        <button data-part="ZUMLINK-DIN-IO">Add ZUMLINK-DIN-IO</button>
        <button data-part="ZUM-HUB4">Add ZUM-HUB4</button>
        <button data-part="CEN-SWPOE-5AC">Add CEN-SWPOE-5AC</button>
        <button data-part="DIN-DMX">Add DIN-DMX</button>
        <button data-part="DIN-AP4">Add DIN-AP4</button>
        <button data-part="DIN-PWS60">Add DIN-PWS60</button>
        <button data-part="DIN-DALI-2">Add DIN-DALI-2</button>
      </div>
      <div class="panel-container" id="panel-container">
        <div class="panel" id="panel"></div>
      </div>
      <button class="help-button">?</button>
    </div>

    <!-- Pick List Chart -->
    <div class="pick-list-container">
      <h3>Pick List</h3>
      <table id="pick-list-table">
        <thead>
          <tr>
            <th>Part Type</th>
            <th>Quantity</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be dynamically added here -->
        </tbody>
      </table>
    </div>

    <!-- CRESTRON Electronics Inc Section -->
    <div class="crestron-container">
      <div class="crestron-header">
        <span class="crestron-title">CRESTRON</span>
        <span class="crestron-subtitle">ELECTRONICS INC</span>
      </div>

      <!-- Electrical Ratings Table -->
      <table class="electrical-ratings-table">
        <thead>
          <tr>
            <th colspan="4">ELECTRICAL RATINGS:</th>
          </tr>
        </thead>
        <tbody>
          <!-- Voltage, Phase, Frequency, FLA (Total) AMP -->
          <tr>
            <td>VOLTAGE VAC</td>
            <td>PHASE</td>
            <td>FREQ. Hz</td>
            <td>FLA (TOTAL) AMP</td>
          </tr>
          <tr>
            <td><input type="text" value="100-277" class="editable"></td>
            <td><input type="text" value="1" class="editable"></td>
            <td><input type="text" value="50/60" class="editable"></td>
            <td>
              <input type="text" value="0" class="editable">
              <span>CKT @</span>
              <input type="text" value="16A" class="editable">
            </td>
          </tr>
          <!-- Repeat the above row 3 more times -->
          <tr>
            <td><input type="text" value="100-277" class="editable"></td>
            <td><input type="text" value="1" class="editable"></td>
            <td><input type="text" value="50/60" class="editable"></td>
            <td>
              <input type="text" value="0" class="editable">
              <span>CKT @</span>
              <input type="text" value="16A" class="editable">
            </td>
          </tr>
          <tr>
            <td><input type="text" value="100-277" class="editable"></td>
            <td><input type="text" value="1" class="editable"></td>
            <td><input type="text" value="50/60" class="editable"></td>
            <td>
              <input type="text" value="0" class="editable">
              <span>CKT @</span>
              <input type="text" value="16A" class="editable">
            </td>
          </tr>
          <tr>
            <td><input type="text" value="100-277" class="editable"></td>
            <td><input type="text" value="1" class="editable"></td>
            <td><input type="text" value="50/60" class="editable"></td>
            <td>
              <input type="text" value="0" class="editable">
              <span>CKT @</span>
              <input type="text" value="16A" class="editable">
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Additional Rows -->
      <table class="additional-ratings-table">
        <tr>
          <td><input type="text" value="N/A" class="editable"></td>
          <td>HP</td>
          <td colspan="1">LARGEST MOTOR</td>
          <td></td> <!-- Extra column for alignment -->
        </tr>
        <tr>
          <td colspan="4">SHORT CIRCUIT CURRENT</td> <!-- Merge all columns -->
        </tr>
        <tr>
          <td><input type="text" value="N/A" class="editable"></td>
          <td>Ka RMS</td>
          <td><input type="text" value="277" class="editable"></td>
          <td>V MAXIMUM</td>
        </tr>
        <tr>
          <td colspan="4">
            BRANCH CIRCUIT PROTECTION SHALL BE PROVIDED BY INSTALLER SEE MODULE MANUAL FOR TERMINAL TIGHTENING TORQUE VALUES.
          </td>
        </tr>
      </table>
    </div>

    <!-- Panel Wiring Tab -->
    <div id="wiring-tab" class="tab">
      <div class="sidebar">
        <button id="generate-panel">Generate Panel</button>
        <button id="auto-wiring-button">Auto Wiring</button>
        <button id="draw-wiring">Draw Wiring</button>
        <button id="clear-wiring">Clear All Wiring</button>
      </div>
      <div class="panel-container">
        <div id="wiring-panel" class="panel"></div>
        <svg class="wiring-svg" id="wiring-svg"></svg>
      </div>
      <button class="help-button">?</button>
    </div>

    <!-- Space Layout Tab -->
    <div id="space-tab" class="tab">
      <div class="space-layout">
        <h2>Space Layout</h2>
        <table id="space-table">
          <thead>
            <tr>
              <th>Space Name</th>
              <th>Load Controller</th>
              <th>mA Draw</th>
              <th>Device mA</th>
              <th>Total Power Draw</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be dynamically added here -->
          </tbody>
        </table>
      </div>
      <button class="help-button">?</button>
    </div>

    <!-- Load Schedule Tab -->
    <div id="load-tab" class="tab">
      <div class="load-schedule">
        <h2>Load Schedule</h2>
        <h3>120V Circuits</h3>
        <table id="load-table-120v">
          <thead>
            <tr>
              <th>Space Name</th>
              <th>Circuit #</th>
              <th>Zone</th>
              <th>Load Controller</th>
              <th>Voltage</th>
              <th>Lighting Load</th>
              <th>Circuit Max (Watts)</th>
              <th>Total Lighting Load</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be dynamically added here -->
          </tbody>
        </table>
        <h3>277V Circuits</h3>
        <table id="load-table-277v">
          <thead>
            <tr>
              <th>Space Name</th>
              <th>Circuit #</th>
              <th>Zone</th>
              <th>Load Controller</th>
              <th>Voltage</th>
              <th>Lighting Load</th>
              <th>Circuit Max (Watts)</th>
              <th>Total Lighting Load</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be dynamically added here -->
          </tbody>
        </table>
      </div>
      <button class="help-button">?</button>
    </div>

    <!-- Part Information Popup -->
    <div id="part-popup" class="wire-popup" style="display: none;">
      <h3>Part Information</h3>
      <form id="part-form">
        <div class="form-row">
          <label for="space-name">Space Name*:</label>
          <input type="text" id="space-name" required>
        </div>
        <div class="form-row">
          <label for="voltage">Voltage VAC:</label>
          <select id="voltage" required>
            <option value="120">120</option>
            <option value="277">277</option>
          </select>
        </div>
        <div class="form-row">
          <label for="circuit-number">Circuit #:</label>
          <input type="text" id="circuit-number">
        </div>
        <div class="form-row">
          <label for="zone">Zone:</label>
          <input type="text" id="zone">
        </div>
        <div class="form-row">
          <label for="lighting-load">Lighting Load (watts):</label>
          <input type="number" id="lighting-load">
        </div>
        <div class="form-row">
          <label for="device-ma">Device mA:</label>
          <input type="number" id="device-ma">
        </div>
        <div class="form-row">
          <button type="submit">Save</button>
          <button type="button" id="close-part-popup">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Project Information Popup -->
    <div id="project-info-popup" class="wire-popup" style="display: none;">
      <h3>Project Information</h3>
      <form id="project-info-form">
        <div class="form-row">
          <label for="project-name">Project Name:</label>
          <input type="text" id="project-name" required>
        </div>
        <div class="form-row">
          <label for="so-number">SO#:</label>
          <input type="text" id="so-number">
        </div>
        <div class="form-row">
          <label for="quote-number">Quote #:</label>
          <input type="text" id="quote-number" required>
        </div>
        <div class="form-row">
          <label for="panel-id">Panel ID:</label>
          <input type="text" id="panel-id">
        </div>
        <div class="form-row">
          <label for="creator">Creator:</label>
          <input type="text" id="creator">
        </div>
        <div class="form-row">
          <label for="revision">Revision:</label>
          <input type="text" id="revision">
        </div>
        <div class="form-row">
          <button type="submit">Save</button>
          <button type="button" id="close-project-info-popup">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Wire Selection Popup -->
    <div id="wire-popup" class="wire-popup" style="display: none;">
      <h3>Select Wire Type</h3>
      <button data-type="CRESNET">CRESNET (Green)</button>
      <button data-type="ETHERNET">ETHERNET (Blue)</button>
      <button data-type="ZUMNET">ZUMNET (Purple)</button>
      <button data-type="ZUMLINK">ZUMLINK (Orange)</button>
      <button data-type="POWER">POWER (Black)</button>
      <button data-type="DMX">DMX (Rainbow Dotted)</button>
    </div>
  </div>
<!-- Wiring Panel -->
  <div id="wiring-panel">
    <!-- Rail 1 -->
    <div class="rail">
      <div class="wire" style="width: 100px;"></div>
      <div class="wire" style="width: 150px;"></div>
      <div class="wire" style="width: 200px;"></div>
    </div>

    <!-- Rail 2 -->
    <div class="rail">
      <div class="wire" style="width: 120px;"></div>
      <div class="wire" style="width: 180px;"></div>
      <div class="wire" style="width: 220px;"></div>
    </div>

    <!-- Rail 3 -->
    <div class="rail">
      <div class="wire" style="width: 130px;"></div>
      <div class="wire" style="width: 160px;"></div>
      <div class="wire" style="width: 250px;"></div>
    </div>

    <!-- Rail 4 -->
    <div class="rail">
      <div class="wire" style="width: 140px;"></div>
      <div class="wire" style="width: 170px;"></div>
      <div class="wire" style="width: 300px;"></div>
    </div>

    <!-- Rail 5 -->
    <div class="rail">
      <div class="wire" style="width: 150px;"></div>
      <div class="wire" style="width: 200px;"></div>
      <div class="wire" style="width: 350px;"></div>
    </div>

    <!-- Rail 6 -->
    <div class="rail">
      <div class="wire" style="width: 160px;"></div>
      <div class="wire" style="width: 210px;"></div>
      <div class="wire" style="width: 400px;"></div>
    </div>

    <!-- Rail 7 -->
    <div class="rail">
      <div class="wire" style="width: 170px;"></div>
      <div class="wire" style="width: 220px;"></div>
      <div class="wire" style="width: 450px;"></div>
    </div>

    <!-- Rail 8 -->
    <div class="rail">
      <div class="wire" style="width: 180px;"></div>
      <div class="wire" style="width: 230px;"></div>
      <div class="wire" style="width: 500px;"></div>
    </div>

    <!-- Rail 9 -->
    <div class="rail">
      <div class="wire" style="width: 190px;"></div>
      <div class="wire" style="width: 240px;"></div>
      <div class="wire" style="width: 550px;"></div>
    </div>

    <!-- Rail 10 -->
    <div class="rail">
      <div class="wire" style="width: 200px;"></div>
      <div class="wire" style="width: 250px;"></div>
      <div class="wire" style="width: 600px;"></div>
    </div>
  </div>

  <script>
  // Preloader Logic
  const preloader = document.getElementById('preloader');
  const preloaderText = document.getElementById('preloader-text');

  function typeText(text, speed, callback) {
    let index = 0;
    const interval = setInterval(() => {
      if (index < text.length) {
        preloaderText.textContent += text[index];
        index++;
      } else {
        clearInterval(interval);
        if (callback) callback();
      }
    }, 100);
  }

  function runPreloader() {
    typeText("Hello, World", 100, () => {
      setTimeout(() => {
        typeText("......", 00, () => {
          setTimeout(() => {
            preloader.classList.add('hidden'); // Fade out the preloader
          }, 500); // Wait 1 second before fading out
        });
      }, 1000); // Wait 0.5 seconds before typing "......"
    });
  }

  runPreloader();

  // Main Page Logic
  const panelSelect = document.getElementById('panel-select');
  const panel = document.getElementById('panel');
  const parts = {
    '1MU': { width: 18, height: 18, color: 'white', mA: 0, dots: [] },
    'Terminal Block': { width: 71, height: 50, color: 'grey', mA: 0, dots: [] },
    'ZUMNET-DIN-DLI': { width: 71, height: 94, color: 'purple', mA: 150, dots: ['purple', 'purple', 'orange', 'orange'] },
    'ZUMNET-DIN-16A-LV': { width: 71, height: 94, color: 'purple', mA: 120, dots: ['purple', 'purple', 'orange', 'orange'] },
    'ZUMLINK-DIN-PSU': { width: 71, height: 94, color: 'grey', mA: 0, dots: ['orange', 'orange', 'orange', 'orange'] }, // Excluded
    'ZUMLINK-DIN-16A-LV': { width: 53, height: 94, color: 'orange', mA: 100, dots: ['orange', 'orange'] },
    'ZUMLINK-DIN-20A-SW': { width: 53, height: 94, color: 'orange', mA: 50, dots: ['orange', 'orange'] },
    'ZUMLINK-DIN-20A-PLUG': { width: 53, height: 94, color: 'orange', mA: 50, dots: ['orange', 'orange'] },
    'ZUMLINK-DIN-DIMU': { width: 53, height: 94, color: 'orange', mA: 100, dots: ['orange', 'orange'] },
    'ZUMLINK-DIN-IO': { width: 71, height: 94, color: 'orange', mA: 145, dots: ['orange', 'orange'] },
    'DIN-DMX': { width: 144, height: 90, dots: ['blue', 'black', 'grey', 'grey'] },
    'ZUM-HUB4': { width: 165, height: 439, dots: ['green', 'purple', 'purple'] },
    'CEN-SWPOE-5AC': { width: 187, height: 120, dots: ['blue', 'blue', 'blue', 'blue', 'blue'] },
    'DIN-AP4': { width: 161, height: 91, dots: ['green', 'green', 'blue'] },
    'DIN-PWS60': { width: 108, height: 94, dots: ['green', 'green', 'green', 'black'] },
    'DIN-DALI-2': { width: 159, height: 95, dots: ['blue', 'green'] },
    'TERMINAL RAIL': { width: 80, height: 50, color: 'multi', dots: [] },
  };

  const panelSizes = {
    'DIN-EN-2X18': { width: 324, height: 323, rails: 2 }, // Fixed panel and rail width to 324mm
    'DIN-EN-3X18': { width: 324, height: 597, rails: 3 },
    'DIN-EN-6X18': { width: 324, height: 989, rails: 6 },
    'DIN-EN-10X18': { width: 324, height: 1594, rails: 10 },
  };

  let rails = [];
  let currentRailIndex = 0;
  let currentXPosition = 0;
  let partsData = [];
  let spaceCounter = 1;

 function initializePanel() {
  const selectedPanel = panelSelect.value;
  const { width, height, rails: railCount } = panelSizes[selectedPanel];
  panel.style.width = `${width}px`;
  panel.style.height = `${height}px`;
  panel.innerHTML = '';

  rails = [];
  const railSpacing = (height / (railCount + 1)) * 1.3; // Increase spacing by 30%
  for (let i = 1; i <= railCount; i++) {
    const rail = document.createElement('div');
    rail.className = 'rail-graphic';
    rail.style.top = `${railSpacing * i - 80}px`;
    rail.style.left = '40px'; // Changed from 20px to 40px to move rails over by 20px
    panel.appendChild(rail);
    rails.push({ element: rail, parts: [], widthUsed: 0 });
  }

  currentRailIndex = 0;
  currentXPosition = 25; // Start from the left edge
}

  // Track part quantities
  const partQuantities = {};

  // Function to toggle visibility of Pick List and CRESTRON Container
  function toggleContainersVisibility(activeTabId) {
    const pickListContainer = document.querySelector('.pick-list-container');
    const crestronContainer = document.querySelector('.crestron-container');

    if (activeTabId === 'wiring-tab') {
      pickListContainer.style.display = 'block';
      crestronContainer.style.display = 'block';
    } else {
      pickListContainer.style.display = 'none';
      crestronContainer.style.display = 'none';
    }
  }

  // Add event listeners to tab buttons
  document.querySelectorAll('.tab-buttons button').forEach((button) => {
    button.addEventListener('click', () => {
      const activeTabId = button.getAttribute('data-tab');
      toggleContainersVisibility(activeTabId);
    });
  });

  // Initialize visibility on page load
  document.addEventListener('DOMContentLoaded', () => {
    const activeTab = document.querySelector('.tab.active').id;
    toggleContainersVisibility(activeTab);
  });

  // Function to update the Pick List
  function updatePickList() {
    const pickListTableBody = document.querySelector('#pick-list-table tbody');
    pickListTableBody.innerHTML = ''; // Clear existing rows

    // Add the panel size as a part with quantity 1
    const panelSize = panelSelect.value;
    partQuantities[panelSize] = 1;

    // Add rows for each part type and its quantity
    Object.entries(partQuantities).forEach(([partType, quantity]) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${partType}</td>
        <td>${quantity}</td>
      `;
      pickListTableBody.appendChild(row);
    });
  }

  function addPart(partType, position = null) {
    const partData = parts[partType];

    // Exclude 1MU and Terminal Block from the Pick List
    const excludedParts = ['1MU', 'Terminal Block'];
    const isExcluded = excludedParts.includes(partType);

    // Exempt ZUM-HUB4 and CEN-SWPOE-5AC from rail numbering and width limitations
    if (partType === 'ZUM-HUB4' || partType === 'CEN-SWPOE-5AC') {
      const part = createPartElement(partType, partData);
      if (position) {
        part.style.left = `${position.left}px`;
        part.style.top = `${position.top}px`;
      } else {
        part.style.left = '50px'; // Default position
        part.style.top = '50px';  // Default position
      }
      panel.appendChild(part);
      makeDraggable(part); // Enable drag-and-drop for these parts

      // Update part quantities for the Pick List (if not excluded)
      if (!isExcluded) {
        if (partQuantities[partType]) {
          partQuantities[partType]++;
        } else {
          partQuantities[partType] = 1;
        }
        updatePickList(); // Update the Pick List
      }
      return;
    }

    // Existing logic for other parts
    if (currentRailIndex >= rails.length) {
      alert('No more rails available in this panel!');
      return;
    }

    // Check if the part will exceed the rail width
    if (rails[currentRailIndex].widthUsed + partData.width > 324) {
      currentRailIndex++; // Move to the next rail
      currentXPosition = 25; // Reset X position
      if (currentRailIndex >= rails.length) {
        alert('No more rails available in this panel!');
        return;
      }
    }

    const part = createPartElement(partType, partData);
    const rail = rails[currentRailIndex];

    // Position the part
    part.style.left = `${currentXPosition}px`;
    part.style.top = `${parseInt(rail.element.style.top) - partData.height / 2}px`;
    rail.parts.push(part);
    rail.widthUsed += partData.width; // Add the part's width to rail.widthUsed
    currentXPosition += partData.width; // Move currentXPosition by the part's width

    panel.appendChild(part);
    makeDraggable(part); // Enable drag-and-drop for these parts

    // Update part quantities for the Pick List (if not excluded)
    if (!isExcluded) {
      if (partQuantities[partType]) {
        partQuantities[partType]++;
      } else {
        partQuantities[partType] = 1;
      }
      updatePickList(); // Update the Pick List
    }

    // Determine the default space name
    let spaceName = `Space ${spaceCounter}`;

    // Logic for ZUMNET parts
    if (partType.startsWith('ZUMNET')) {
      // Find the last ZUMNET part added
      const lastZUMNET = partsData
        .filter((p) => p.partType.startsWith('ZUMNET'))
        .pop();

      if (lastZUMNET) {
        // Extract the space number from the last ZUMNET's space name
        const lastSpaceNumber = parseInt(lastZUMNET.spaceName.split(' ')[1]);
        spaceName = `Space ${lastSpaceNumber + 1}`;
      } else {
        // If no ZUMNET parts have been added yet, default to Space 1
        spaceName = `Space 1`;
      }
    }

    // Logic for ZUMLINK parts (excluding ZUMLINK-DIN-IO)
    if (partType.startsWith('ZUMLINK') && partType !== 'ZUMLINK-DIN-IO') {
      const rail = rails[currentRailIndex];
      const currentIndex = rail.parts.length - 1; // Index of the current part

      if (currentIndex > 0) {
        // If there's a part to the left, mimic its space name
        const leftPart = rail.parts[currentIndex - 1];
        const leftPartData = partsData.find((p) => p.partElement === leftPart);
        if (leftPartData) {
          spaceName = leftPartData.spaceName;
        }
      } else if (currentRailIndex > 0) {
        // If this is the first part on a new row, look to the last part on the row above
        const railAbove = rails[currentRailIndex - 1];
        if (railAbove.parts.length > 0) {
          const lastPartAbove = railAbove.parts[railAbove.parts.length - 1];
          const lastPartAboveData = partsData.find((p) => p.partElement === lastPartAbove);
          if (lastPartAboveData) {
            spaceName = lastPartAboveData.spaceName;
          }
        }
      }
    }

    // Add space name to the part
    const spaceNameElement = document.createElement('div');
    spaceNameElement.className = 'space-name';
    spaceNameElement.textContent = spaceName;
    part.appendChild(spaceNameElement);

    // Add rail number to the part
    const railNumber = currentRailIndex + 1; // Rail numbers start from 1
    part.setAttribute('data-rail-number', railNumber);

    // Add part data to partsData array
    partsData.push({
      partElement: part,
      partType: partType,
      spaceName: spaceName,
      circuitNumber: null,
      zone: null,
      lightingLoad: null,
      deviceMA: null,
      railNumber: railNumber,
      voltage: 120, // Default voltage
    });

    // Increment space counter if the part is a ZUMNET device
    if (partType.startsWith('ZUMNET')) {
      spaceCounter++;
    }
  }

  function createPartElement(partType, partData) {
    const part = document.createElement('div');
    part.className = 'part draggable';
    part.style.width = `${partData.width}px`;
    part.style.height = `${partData.height}px`;
    part.textContent = partType;
    part.style.backgroundColor = partData.color || '#4CAF50';

    // Add double-click to edit
    part.addEventListener('dblclick', () => showPartPopup(partType, part));

    // Add right-click to delete with confirmation popup
    part.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const confirmDelete = confirm('Are you sure you want to delete this part?');
      if (confirmDelete) {
        part.remove();
        partsData = partsData.filter((p) => p.partElement !== part);
        updateSpaceTable();
        updateLoadSchedule();
      }
    });

    return part;
  }

  function makeDraggable(element) {
    let isDragging = false;
    let offsetX, offsetY;
    let dragTimeout;
    let lastTap = 0; // Variable to track the time of the last tap

    // Mouse event handlers
    element.addEventListener('mousedown', (e) => {
      // Start a timeout to initiate dragging after 1 second
      dragTimeout = setTimeout(() => {
        isDragging = true;

        // Calculate the offset relative to the mouse cursor
        const rect = element.getBoundingClientRect();
        offsetX = e.clientX - rect.left; // Offset X relative to the part's left edge
        offsetY = e.clientY - rect.top;  // Offset Y relative to the part's top edge

        element.style.cursor = 'grabbing';
      }, 1000); // 1 second delay
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        // Calculate the new position of the part
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;

        // Snap to rails if within 5px
        rails.forEach(rail => {
          const railRect = rail.element.getBoundingClientRect();
          if (Math.abs(newY - railRect.top) < 5) {
            newY = railRect.top;
          }
        });

        // Snap to other parts if within 5px
        const parts = document.querySelectorAll('.part');
        parts.forEach(part => {
          if (part !== element) {
            const partRect = part.getBoundingClientRect();
            if (Math.abs(newX - partRect.right) < 5) {
              newX = partRect.right;
            }
            if (Math.abs(newX - partRect.left) < 5) {
              newX = partRect.left - element.offsetWidth;
            }
          }
        });

        // Update the part's position
        element.style.left = `${newX}px`;
        element.style.top = `${newY}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      clearTimeout(dragTimeout); // Clear the timeout if the mouse is released before 1 second
      isDragging = false;
      element.style.cursor = 'grab';

      // Update the part's position in the partsData array
      const partData = partsData.find(p => p.partElement === element);
      if (partData) {
        partData.position = {
          left: element.style.left,
          top: element.style.top
        };
      }
    });

    // Touch event handlers for double-tap
    element.addEventListener('touchend', (e) => {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTap;

      if (tapLength < 300 && tapLength > 0) {
        // Double-tap detected
        showPartPopup(element.getAttribute('data-part'), element);
      }

      lastTap = currentTime;
    });

    // Touch event handlers for dragging
    element.addEventListener('touchstart', (e) => {
      e.preventDefault(); // Prevent default touch behavior
      dragTimeout = setTimeout(() => {
        isDragging = true;
        const touch = e.touches[0]; // Get the first touch point

        // Calculate the offset relative to the touch point
        const rect = element.getBoundingClientRect();
        offsetX = touch.clientX - rect.left; // Offset X relative to the part's left edge
        offsetY = touch.clientY - rect.top;  // Offset Y relative to the part's top edge

        element.style.cursor = 'grabbing';
      }, 1000); // 1 second delay
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const touch = e.touches[0]; // Get the first touch point

        // Calculate the new position of the part
        let newX = touch.clientX - offsetX;
        let newY = touch.clientY - offsetY;

        // Snap to rails if within 5px
        rails.forEach(rail => {
          const railRect = rail.element.getBoundingClientRect();
          if (Math.abs(newY - railRect.top) < 5) {
            newY = railRect.top;
          }
        });

        // Snap to other parts if within 5px
        const parts = document.querySelectorAll('.part');
        parts.forEach(part => {
          if (part !== element) {
            const partRect = part.getBoundingClientRect();
            if (Math.abs(newX - partRect.right) < 5) {
              newX = partRect.right;
            }
            if (Math.abs(newX - partRect.left) < 5) {
              newX = partRect.left - element.offsetWidth;
            }
          }
        });

        // Update the part's position
        element.style.left = `${newX}px`;
        element.style.top = `${newY}px`;
      }
    });

    document.addEventListener('touchend', () => {
      clearTimeout(dragTimeout); // Clear the timeout if the touch ends before 1 second
      isDragging = false;
      element.style.cursor = 'grab';

      // Update the part's position in the partsData array
      const partData = partsData.find(p => p.partElement === element);
      if (partData) {
        partData.position = {
          left: element.style.left,
          top: element.style.top
        };
      }
    });
  }

  function adjustFontSize(spaceName, part) {
    const partWidth = part.offsetWidth;
    const spaceNameWidth = spaceName.offsetWidth;
    let fontSize = 10;

    while (spaceNameWidth > partWidth && fontSize > 6) {
      fontSize--;
      spaceName.style.fontSize = `${fontSize}px`;
    }
  }

  function showPartPopup(partType, partElement) {
    const partPopup = document.getElementById('part-popup');
    const partForm = document.getElementById('part-form');

    // Find the part data
    const partData = partsData.find((p) => p.partElement === partElement);

    // Populate the form with existing data
    document.getElementById('space-name').value = partData.spaceName;
    document.getElementById('circuit-number').value = partData.circuitNumber || '';
    document.getElementById('zone').value = partData.zone || '';
    document.getElementById('lighting-load').value = partData.lightingLoad || '';
    document.getElementById('device-ma').value = partData.deviceMA || '';
    document.getElementById('voltage').value = partData.voltage || '120'; // Default to 120V

    // Show the popup
    partPopup.style.display = 'block';

    // Handle form submission
    partForm.onsubmit = (e) => {
      e.preventDefault();

      // Update part data
      partData.spaceName = document.getElementById('space-name').value;
      partData.circuitNumber = document.getElementById('circuit-number').value;
      partData.zone = document.getElementById('zone').value;
      partData.lightingLoad = document.getElementById('lighting-load').value;
      partData.deviceMA = document.getElementById('device-ma').value;
      partData.voltage = document.getElementById('voltage').value; // Update voltage

      // Update the part's space name
      const spaceNameElement = partElement.querySelector('.space-name');
      if (spaceNameElement) {
        spaceNameElement.textContent = partData.spaceName;
        adjustFontSize(spaceNameElement, partElement);
      }

      // Update the data indicator (exclude deviceMA from the check)
      const dataIndicator = partElement.querySelector('.data-indicator');
      if (dataIndicator) {
        if (partData.circuitNumber && partData.zone && partData.lightingLoad) {
          dataIndicator.classList.add('green');
          dataIndicator.classList.remove('red');
        } else {
          dataIndicator.classList.add('red');
          dataIndicator.classList.remove('green');
        }
      }

      // Hide the popup
      partPopup.style.display = 'none';

      // Update tables
      updateSpaceTable();
      updateLoadSchedule();
    };
  }

  // Close the part information popup when Cancel is clicked
  document.getElementById('close-part-popup').addEventListener('click', () => {
    document.getElementById('part-popup').style.display = 'none';
  });

  function updateSpaceTable() {
    const spaceTableBody = document.querySelector('#space-table tbody');
    spaceTableBody.innerHTML = '';

    const spaceMap = {};

    partsData.forEach((part) => {
      if (part.partType === 'ZUMLINK-DIN-PSU') return; // Exclude ZUMLINK-DIN-PSU

      if (!spaceMap[part.spaceName]) {
        spaceMap[part.spaceName] = {
          parts: [],
          mA: 0,
          deviceMA: 0,
        };
      }

      // Add part and zone to the list
      spaceMap[part.spaceName].parts.push({ partType: part.partType, zone: part.zone });

      // Sum mA Draw (only for parts starting with "ZUM")
      if (part.partType.startsWith("ZUM")) {
        spaceMap[part.spaceName].mA += Number(parts[part.partType].mA) || 0;
      }

      // Sum Device mA
      spaceMap[part.spaceName].deviceMA += Number(part.deviceMA) || 0;
    });

    Object.keys(spaceMap).forEach((spaceName) => {
      const row = document.createElement('tr');

      // Create nested table for Load Controller column
      const nestedTable = document.createElement('table');
      nestedTable.className = 'nested-table';
      spaceMap[part.spaceName].parts.forEach((part) => {
        const nestedRow = document.createElement('tr');
        nestedRow.innerHTML = `
          <td>${part.partType}</td>
          <td>${part.zone}</td>
        `;
        nestedTable.appendChild(nestedRow);
      });

      // Calculate Total Power Draw
      const totalPowerDraw = Number(spaceMap[part.spaceName].mA) + Number(spaceMap[part.spaceName].deviceMA);

      row.innerHTML = `
        <td><input type="text" value="${spaceName}" onchange="updateSpaceName('${spaceName}', this.value)"></td>
        <td></td>
        <td>${spaceMap[part.spaceName].mA} mA</td>
        <td>${spaceMap[part.spaceName].deviceMA} mA</td>
        <td>${totalPowerDraw} mA</td>
      `;
      row.querySelector('td:nth-child(2)').appendChild(nestedTable);
      spaceTableBody.appendChild(row);
    });
  }

  function updateLoadSchedule() {
    const loadTable120VBody = document.querySelector('#load-table-120v tbody');
    const loadTable277VBody = document.querySelector('#load-table-277v tbody');
    loadTable120VBody.innerHTML = '';
    loadTable277VBody.innerHTML = '';

    const circuitMap120V = {}; // Group 120V parts by circuit number
    const circuitMap277V = {}; // Group 277V parts by circuit number

    // Group parts by circuit number and voltage
    partsData.forEach((part) => {
      if (!part.circuitNumber) return;

      const circuitMap = part.voltage === '277' ? circuitMap277V : circuitMap120V;

      if (!circuitMap[part.circuitNumber]) {
        circuitMap[part.circuitNumber] = {
          parts: [],
          totalLightingLoad: 0,
          voltage: part.voltage,
        };
      }

      circuitMap[part.circuitNumber].parts.push(part);
      circuitMap[part.circuitNumber].totalLightingLoad += Number(part.lightingLoad) || 0;
    });

    // Function to populate the table for a specific voltage
    const populateTable = (circuitMap, tableBody) => {
      Object.keys(circuitMap).forEach((circuitNumber) => {
        const circuitData = circuitMap[circuitNumber];
        const circuitMaxWatts = circuitData.voltage * 16; // Calculate Circuit Max (Watts)
        const rowCount = circuitData.parts.length; // Number of rows for this circuit

        // Create rows for each part in the circuit
        circuitData.parts.forEach((part, index) => {
          const row = document.createElement('tr');

          // Space Name
          const spaceNameCell = document.createElement('td');
          spaceNameCell.textContent = part.spaceName;
          row.appendChild(spaceNameCell);

          // Circuit #
          const circuitCell = document.createElement('td');
          circuitCell.textContent = part.circuitNumber;
          row.appendChild(circuitCell);

          // Zone
          const zoneCell = document.createElement('td');
          zoneCell.textContent = part.zone;
          row.appendChild(zoneCell);

          // Load Controller
          const loadControllerCell = document.createElement('td');
          loadControllerCell.textContent = part.partType;
          row.appendChild(loadControllerCell);

          const voltageCell = document.createElement('td');
          voltageCell.textContent = part.voltage;
          row.appendChild(voltageCell);

          // Lighting Load
          const lightingLoadCell = document.createElement('td');
          lightingLoadCell.textContent = `${part.lightingLoad} W`;
          row.appendChild(lightingLoadCell);

          // Circuit Max (Watts) - Merged Cell
          if (index === 0) {
            const circuitMaxCell = document.createElement('td');
            circuitMaxCell.textContent = `${circuitMaxWatts} W`;
            circuitMaxCell.setAttribute('rowspan', rowCount); // Merge rows
            row.appendChild(circuitMaxCell);
          }

          // Total Lighting Load - Merged Cell
          if (index === 0) {
            const totalLightingLoadCell = document.createElement('td');
            totalLightingLoadCell.textContent = `${circuitData.totalLightingLoad} W`;
            totalLightingLoadCell.setAttribute('rowspan', rowCount); // Merge rows

            // Highlight if total exceeds circuit max
            if (circuitData.totalLightingLoad > circuitMaxWatts) {
              totalLightingLoadCell.style.fontWeight = 'bold';
              totalLightingLoadCell.style.color = 'red';
            }

            row.appendChild(totalLightingLoadCell);
          }

          // Add the row to the table
          tableBody.appendChild(row);
        });
      });
    };

    // Populate the table for 120V and 277V parts
    populateTable(circuitMap120V, loadTable120VBody);
    populateTable(circuitMap277V, loadTable277VBody);
  }

  // Add event listeners to all "?" buttons
  document.querySelectorAll('.help-button').forEach((button) => {
    button.addEventListener('click', () => {
      const helpPopup = document.getElementById('help-popup');

      // Check if the popup exists
      if (!helpPopup) {
        console.error('Help popup not found in the DOM.');
        return;
      }

      // Determine the active tab and update popup content
      const activeTab = document.querySelector('.tab.active').id;

      let pageInfoContent = '';
      let faqContent = '';

      switch (activeTab) {
        case 'main-tab':
          pageInfoContent = 'This is the Page Info for the Main Page.';
          faqContent = 'This is the FAQ for the Main Page.';
          break;
        case 'wiring-tab':
          pageInfoContent = 'This is the Page Info for the Panel Wiring Page.';
          faqContent = 'This is the FAQ for the Panel Wiring Page.';
          break;
        case 'space-tab':
          pageInfoContent = 'This is the Page Info for the Space Layout Page.';
          faqContent = 'This is the FAQ for the Space Layout Page.';
          break;
        case 'load-tab':
          pageInfoContent = 'This is the Page Info for the Load Schedule Page.';
          faqContent = 'This is the FAQ for the Load Schedule Page.';
          break;
      }

      // Update the popup content
      document.getElementById('page-info-tab').innerHTML = `<p>${pageInfoContent}</p>`;
      document.getElementById('faq-tab').innerHTML = `<p>${faqContent}</p>`;

      // Show the popup
      helpPopup.style.display = 'block';
    });
  });

  // Close the help popup when the close button is clicked
  document.getElementById('close-help-popup').addEventListener('click', () => {
    const helpPopup = document.getElementById('help-popup');
    if (helpPopup) {
      helpPopup.style.display = 'none';
    }
  });

  // Tab switching logic for the help popup
  const pageInfoTabButton = document.getElementById('page-info-tab-button');
  const faqTabButton = document.getElementById('faq-tab-button');
  const pageInfoTab = document.getElementById('page-info-tab');
  const faqTab = document.getElementById('faq-tab');

  if (pageInfoTabButton && faqTabButton && pageInfoTab && faqTab) {
    pageInfoTabButton.addEventListener('click', () => {
      pageInfoTab.classList.add('active');
      faqTab.classList.remove('active');
      pageInfoTabButton.classList.add('active');
      faqTabButton.classList.remove('active');
    });

    faqTabButton.addEventListener('click', () => {
      faqTab.classList.add('active');
      pageInfoTab.classList.remove('active');
      faqTabButton.classList.add('active');
      pageInfoTabButton.classList.remove('active');
    });
  }

  function updateSpaceName(oldName, newName) {
    partsData.forEach((part) => {
      if (part.spaceName === oldName) {
        part.spaceName = newName;
      }
    });
    updateSpaceTable();
    updateLoadSchedule();
  }

  document.getElementById('generate-panel').addEventListener('click', () => {
    const wiringPanel = document.getElementById('wiring-panel');
    wiringPanel.innerHTML = ''; // Clear the wiring panel

    // Get all parts from the main panel
    const parts = document.querySelectorAll('#panel .part');

    // Iterate through each part and clone it with its current position
    parts.forEach((part) => {
      const clonedPart = part.cloneNode(true); // Clone the part
      clonedPart.style.position = 'absolute'; // Ensure the part is positioned absolutely

      // Use the current position of the part in the main panel
      const currentLeft = parseFloat(part.style.left); // Get the current left position
      const currentTop = parseFloat(part.style.top); // Get the current top position

      // Set the position of the cloned part based on the current position
      clonedPart.style.left = `${currentLeft}px`;
      clonedPart.style.top = `${currentTop}px`;

      // Disable animations and make the part non-editable
      clonedPart.style.animation = 'none';
      clonedPart.classList.add('non-editable');

      // Add dots for wire connection points at the bottom of the part
      const dotsContainer = document.createElement('div');
      dotsContainer.className = 'dots-container';
      dotsContainer.style.position = 'absolute';
      dotsContainer.style.bottom = '0';
      dotsContainer.style.left = '50%';
      dotsContainer.style.transform = 'translateX(-50%)';
      dotsContainer.style.display = 'flex';
      dotsContainer.style.gap = '10px';

      // Determine the number and color of dots based on the part type or color
      const partType = part.getAttribute('data-part'); // Use the data-part attribute to identify the part
      const partColor = clonedPart.style.backgroundColor; // Get the background color of the part

      let dotColors = [];

      if (partColor === 'grey' || partColor === 'gray') {
        // Grey parts get 4 brown dots
        dotColors = ['brown', 'brown', 'brown', 'brown'];
      } else if (partColor === 'purple') {
        // Purple parts get 2 purple and 2 orange dots
        dotColors = ['purple', 'purple', 'orange', 'orange'];
      } else if (partColor === 'orange') {
        // Orange parts get 2 orange dots
        dotColors = ['orange', 'orange'];
      }

      // Create and append the dots
      dotColors.forEach((color) => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.width = '10px';
        dot.style.height = '10px';
        dot.style.backgroundColor = color;
        dot.style.borderRadius = '50%';
        dotsContainer.appendChild(dot);
      });

      clonedPart.appendChild(dotsContainer);

      // Append the cloned part to the wiring panel
      wiringPanel.appendChild(clonedPart);
    });

    // Add a class to the wiring panel to disable further editing
    wiringPanel.classList.add('non-editable');
  });

  panelSelect.addEventListener('change', initializePanel);
  document.querySelectorAll('.sidebar button[data-part]').forEach((button) => {
    button.addEventListener('click', () => {
      addPart(button.getAttribute('data-part'));
    });
  });

  initializePanel();

  // Tab Switching Logic
  const mainTabButton = document.getElementById('main-tab-button');
  const wiringTabButton = document.getElementById('wiring-tab-button');
  const spaceTabButton = document.getElementById('space-tab-button');
  const loadTabButton = document.getElementById('load-tab-button');
  const mainTab = document.getElementById('main-tab');
  const wiringTab = document.getElementById('wiring-tab');
  const spaceTab = document.getElementById('space-tab');
  const loadTab = document.getElementById('load-tab');

  mainTabButton.addEventListener('click', () => {
    mainTab.classList.add('active');
    wiringTab.classList.remove('active');
    spaceTab.classList.remove('active');
    loadTab.classList.remove('active');
    mainTabButton.classList.add('active');
    wiringTabButton.classList.remove('active');
    spaceTabButton.classList.remove('active');
    loadTabButton.classList.remove('active');
  });

  wiringTabButton.addEventListener('click', () => {
    wiringTab.classList.add('active');
    mainTab.classList.remove('active');
    spaceTab.classList.remove('active');
    loadTab.classList.remove('active');
    wiringTabButton.classList.add('active');
    mainTabButton.classList.remove('active');
    spaceTabButton.classList.remove('active');
    loadTabButton.classList.remove('active');
  });

  spaceTabButton.addEventListener('click', () => {
    spaceTab.classList.add('active');
    mainTab.classList.remove('active');
    wiringTab.classList.remove('active');
    loadTab.classList.remove('active');
    spaceTabButton.classList.add('active');
    mainTabButton.classList.remove('active');
    wiringTabButton.classList.remove('active');
    loadTabButton.classList.remove('active');
  });

  loadTabButton.addEventListener('click', () => {
    loadTab.classList.add('active');
    mainTab.classList.remove('active');
    wiringTab.classList.remove('active');
    spaceTab.classList.remove('active');
    loadTabButton.classList.add('active');
    mainTabButton.classList.remove('active');
    wiringTabButton.classList.remove('active');
    spaceTabButton.classList.remove('active');
  });

  document.getElementById('auto-wiring-button').addEventListener('click', autoWire);

  function autoWire() {
    const parts = document.querySelectorAll('.part'); // Get all parts
    const orangeDots = []; // Previously red dots
    const purpleDots = []; // Previously black dots

    // Step 1: Identify all orange and purple dots, their positions, and their space names
    parts.forEach((part) => {
      const partRect = part.getBoundingClientRect();
      const dots = part.querySelectorAll('.dot');
      const spaceName = part.querySelector('.space-name')?.textContent || 'Unnamed'; // Get the space name

      dots.forEach((dot) => {
        const dotRect = dot.getBoundingClientRect();
        const dotData = {
          part,
          dot,
          x: dotRect.left + dotRect.width / 2 - partRect.left + part.offsetLeft,
          y: dotRect.top + dotRect.height / 2 - partRect.top + part.offsetTop,
          spaceName, // Add the space name to the dot
        };

        if (dot.style.backgroundColor === 'orange') {
          orangeDots.push(dotData); // Add to orange dots
        } else if (dot.style.backgroundColor === 'purple') {
          purpleDots.push(dotData); // Add to purple dots
        }
      });
    });

    // Step 2: Wire orange dots (with space name restrictions)
    wireDots(orangeDots, 'orange', true);

    // Step 3: Wire purple dots (without space name restrictions)
    wireDots(purpleDots, 'purple', false);
  }

  function wireDots(dots, color, useSpaceNameRestriction) {
    // Step 1: Group dots by their space name (if using space name restriction)
    const spaceGroups = {};
    dots.forEach((dot) => {
      const groupKey = useSpaceNameRestriction ? dot.spaceName : 'all'; // Use space name or group all together
      if (!spaceGroups[groupKey]) {
        spaceGroups[groupKey] = [];
      }
      spaceGroups[groupKey].push(dot);
    });

    // Step 2: For each group, group dots by their Y-axis (rows)
    Object.values(spaceGroups).forEach((groupDots) => {
      const rows = {};
      groupDots.forEach((dot) => {
        if (!rows[dot.y]) {
          rows[dot.y] = [];
        }
        rows[dot.y].push(dot);
      });

      // Step 3: Sort rows by Y-axis (top to bottom)
      const sortedRows = Object.keys(rows).sort((a, b) => a - b);

      // Step 4: Connect dots in each row
      for (let i = 0; i < sortedRows.length; i++) {
        const rowY = sortedRows[i];
        const rowDots = rows[rowY].sort((a, b) => a.x - b.x); // Sort dots in the row from left to right

        // Skip the first dot in the row
        for (let j = 1; j < rowDots.length - 1; j += 2) {
          const startDot = rowDots[j];
          const endDot = rowDots[j + 1];

          // Ensure purple dots only connect to different space names
          if (color === 'purple' && startDot.spaceName === endDot.spaceName) {
            continue; // Skip if space names are the same
          }

          // Draw wire from startDot to endDot
          const verticalOffset = color === 'purple' ? 25 : 20; // Purple wires come down 5px more
          drawWire([
            { x: startDot.x, y: startDot.y }, // Start at the start dot
            { x: startDot.x, y: startDot.y + verticalOffset }, // Go down (20px for orange, 25px for purple)
            { x: endDot.x, y: startDot.y + verticalOffset }, // Go over to the end dot
            { x: endDot.x, y: endDot.y }, // Go up to the end dot
          ], color);
        }

        // Handle the last dot in the row
        if (rowDots.length > 1 && rowDots.length % 2 === 0) {
          const lastDot = rowDots[rowDots.length - 1];

          // Check if there is a row below
          if (i < sortedRows.length - 1) {
            const nextRowY = sortedRows[i + 1];
            const nextRowDots = rows[nextRowY].sort((a, b) => a.x - b.x);

            if (nextRowDots.length > 0) {
              const firstDotNextRow = nextRowDots[0]; // Leftmost dot on the next row

              // Ensure purple dots only connect to different space names
              if (color === 'purple' && lastDot.spaceName === firstDotNextRow.spaceName) {
                continue; // Skip if space names are the same
              }

              // Draw wire from lastDot to firstDotNextRow with the specified path
              const verticalOffset = color === 'purple' ? 25 : 20; // Purple wires come down 5px more
              const horizontalOffset = 30; // Horizontal offset for direction changes
              drawWire([
                { x: lastDot.x, y: lastDot.y }, // Start at the last dot
                { x: lastDot.x, y: lastDot.y + verticalOffset + 20 }, // Go down (20px for orange, 25px for purple) + 20px more
                { x: firstDotNextRow.x - horizontalOffset, y: lastDot.y + verticalOffset + 20 }, // Go over 30px past the leftmost dot below
                { x: firstDotNextRow.x - horizontalOffset, y: firstDotNextRow.y + verticalOffset }, // Go down to the level of the next dot
                { x: firstDotNextRow.x, y: firstDotNextRow.y + verticalOffset }, // Go over to the first dot on the next row
                { x: firstDotNextRow.x, y: firstDotNextRow.y }, // Go up to the first dot on the next row
              ], color);
            }
          }
        }
      }
    });
  }

  function drawWire(path, color) {
    const svgNS = "http://www.w3.org/2000/svg";
    const polyline = document.createElementNS(svgNS, "polyline");

    // Format the points string
    const points = path.map((p) => `${p.x},${p.y}`).join(' ');
    polyline.setAttribute('points', points);
    polyline.setAttribute('stroke', color); // Use the updated color
    polyline.setAttribute('fill', 'none');
    polyline.setAttribute('stroke-width', '2');

    // Append the polyline to the SVG container
    const wiringSvg = document.getElementById('wiring-svg');
    wiringSvg.appendChild(polyline);
  }

  // Wire Drawing Logic
  const wiringSvg = document.getElementById('wiring-svg');
  const wirePopup = document.getElementById('wire-popup');
  const drawWiringButton = document.getElementById('draw-wiring');
  const clearWiringButton = document.getElementById('clear-wiring');
  let isDrawing = false;
  let currentWireType = 'POWER'; // Default wire type
  let wirePoints = []; // Stores the points of the current wire
  let previewLine = null; // Preview line for the wire
  let lastPoint = null; // Last point in the wire

  // Show wire selection popup
  drawWiringButton.addEventListener('click', () => {
    if (!isDrawing) {
      wirePopup.style.display = 'block';
    }
  });

  // Handle wire type selection
  wirePopup.querySelectorAll('button').forEach((button) => {
    button.addEventListener('click', () => {
      currentWireType = button.getAttribute('data-type');
      wirePopup.style.display = 'none';
      startDrawing();
    });
  });

  // Start drawing a wire
  function startDrawing() {
    isDrawing = true;
    wirePoints = [];
    lastPoint = null;
    wiringSvg.style.pointerEvents = 'all';
    wiringSvg.addEventListener('click', handleClick);
    document.addEventListener('keydown', handleKeyDown);
    wiringSvg.addEventListener('mousemove', handleMouseMove);
  }

  // Handle mouse clicks to add points
  function handleClick(e) {
    const rect = wiringSvg.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    // Check if the click is near a dot
    const nearestDot = findNearestDot(x, y);
    if (nearestDot) {
      x = nearestDot.x;
      y = nearestDot.y;
    }

    if (!lastPoint) {
      // First click: start the wire
      wirePoints.push({ x, y });
      lastPoint = { x, y };
    } else {
      // Subsequent clicks: add a new point in 90-degree direction
      const dx = x - lastPoint.x;
      const dy = y - lastPoint.y;

      if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal movement
        wirePoints.push({ x, y: lastPoint.y });
      } else {
        // Vertical movement
        wirePoints.push({ x: lastPoint.x, y });
      }

      lastPoint = wirePoints[wirePoints.length - 1];
      drawWireSegment();
    }
  }

  // Handle keydown events (Enter to end wire, Ctrl+Z to undo, Ctrl+Y to redo)
  function handleKeyDown(e) {
    if (e.key === 'Enter') {
      if (wirePoints.length > 1) {
        // Draw the final wire
        drawWireSegment();
        endDrawing();
      }
    } else if (e.ctrlKey && e.key === 'z') {
      undo();
    } else if (e.ctrlKey && e.key === 'y') {
      redo();
    }
  }

  // Handle mouse movement to show preview
  function handleMouseMove(e) {
    if (!isDrawing || wirePoints.length === 0) return;

    const rect = wiringSvg.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    // Check if the mouse is near a dot
    const nearestDot = findNearestDot(x, y);
    if (nearestDot) {
      x = nearestDot.x;
      y = nearestDot.y;
    }

    // Remove existing preview line
    if (previewLine) {
      previewLine.remove();
    }

    // Draw preview line in 90-degree direction
    const lastPoint = wirePoints[wirePoints.length - 1];
    const dx = x - lastPoint.x;
    const dy = y - lastPoint.y;

    if (Math.abs(dx) > Math.abs(dy)) {
      // Horizontal preview
      previewLine = drawLine(lastPoint.x, lastPoint.y, x, lastPoint.y, currentWireType, true);
    } else {
      // Vertical preview
      previewLine = drawLine(lastPoint.x, lastPoint.y, lastPoint.x, y, currentWireType, true);
    }
  }

  // Draw a wire segment between the last two points
  function drawWireSegment() {
    if (wirePoints.length < 2) return;

    const start = wirePoints[wirePoints.length - 2];
    const end = wirePoints[wirePoints.length - 1];
    drawLine(start.x, start.y, end.x, end.y, currentWireType);
  }

  // Draw a line between two points
  function drawLine(x1, y1, x2, y2, type, isPreview = false) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', getWireColor(type));
    line.setAttribute('stroke-width', '6');

    if (type === 'DMX') {
      line.setAttribute('stroke-dasharray', '5,5');
    }

    if (isPreview) {
      line.setAttribute('stroke-opacity', '0.5');
    }

    wiringSvg.appendChild(line);
    return line;
  }

  // End drawing and reset state
  function endDrawing() {
    isDrawing = false;
    wirePoints = [];
    lastPoint = null;
    wiringSvg.removeEventListener('click', handleClick);
    document.removeEventListener('keydown', handleKeyDown);
    wiringSvg.removeEventListener('mousemove', handleMouseMove);

    // Remove preview line
    if (previewLine) {
      previewLine.remove();
      previewLine = null;
    }

    // Wait 2 seconds before allowing the next wire run
    setTimeout(() => {
      wiringSvg.style.pointerEvents = 'none';
    }, 2000);
  }

  // Get wire color based on type
  function getWireColor(type) {
    switch (type) {
      case 'CRESNET': return 'green';
      case 'ETHERNET': return 'blue';
      case 'ZUMNET': return 'purple';
      case 'ZUMLINK': return 'orange';
      case 'POWER': return 'black';
      case 'DMX': return 'url(#rainbow)';
      default: return 'black';
    }
  }

  // Clear all wires
  clearWiringButton.addEventListener('click', () => {
    wiringSvg.innerHTML = '';
    // Re-add the gradient definition for DMX wires
    wiringSvg.appendChild(defs);
  });

  // Add rainbow gradient for DMX wires
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradient.setAttribute('id', 'rainbow');
  gradient.setAttribute('x1', '0%');
  gradient.setAttribute('y1', '0%');
  gradient.setAttribute('x2', '100%');
  gradient.setAttribute('y2', '0%');
  gradient.innerHTML = `
    <stop offset="0%" style="stop-color:red;stop-opacity:1" />
    <stop offset="16.67%" style="stop-color:orange;stop-opacity:1" />
    <stop offset="33.33%" style="stop-color:yellow;stop-opacity:1" />
    <stop offset="50%" style="stop-color:green;stop-opacity:1" />
    <stop offset="66.67%" style="stop-color:blue;stop-opacity:1" />
    <stop offset="83.33%" style="stop-color:indigo;stop-opacity:1" />
    <stop offset="100%" style="stop-color:violet;stop-opacity:1" />
  `;
  defs.appendChild(gradient);
  wiringSvg.appendChild(defs);

  // Function to find the nearest dot
  function findNearestDot(x, y) {
    let nearestDot = null;
    let minDistance = Infinity;
    const threshold = 0; // Distance threshold for snapping (in pixels)

    // Loop through all parts and their dots
    document.querySelectorAll('.part').forEach((part) => {
      const partRect = part.getBoundingClientRect();
      const dots = part.querySelectorAll('.dot');

      dots.forEach((dot) => {
        const dotRect = dot.getBoundingClientRect();
        const dotCenterX = dotRect.left + dotRect.width / 2 - partRect.left;
        const dotCenterY = dotRect.top + dotRect.height / 2 - partRect.top;

        // Calculate distance between wire endpoint and dot center
        const distance = Math.sqrt((x - dotCenterX) ** 2 + (y - dotCenterY) ** 2);

        // Check if this dot is the nearest
        if (distance < threshold && distance < minDistance) {
          minDistance = distance;
          nearestDot = { x: dotCenterX, y: dotCenterY };
        }
      });
    });

    return nearestDot;
  }

  // Undo functionality
  let undoStack = [];
  let redoStack = [];

  function undo() {
    if (undoStack.length > 0) {
      const lastWire = undoStack.pop();
      redoStack.push(lastWire);
      lastWire.remove();
    }
  }

  // Redo functionality
  function redo() {
    if (redoStack.length > 0) {
      const lastWire = redoStack.pop();
      undoStack.push(lastWire);
      wiringSvg.appendChild(lastWire);
    }
  }

  // Show the project information popup when Save is clicked
  document.getElementById('save-button').addEventListener('click', () => {
    const projectInfoPopup = document.getElementById('project-info-popup');
    projectInfoPopup.style.display = 'block';
  });

  // Handle form submission
  document.getElementById('project-info-form').onsubmit = (e) => {
    e.preventDefault();

    // Collect project information
    const projectName = document.getElementById('project-name').value;
    const soNumber = document.getElementById('so-number').value;
    const quoteNumber = document.getElementById('quote-number').value;
    const panelId = document.getElementById('panel-id').value;
    const creator = document.getElementById('creator').value;
    const revision = document.getElementById('revision').value;

    // Validate required fields
    if (!projectName || !quoteNumber) {
      alert('Project Name and Quote # are required!');
      return;
    }

    // Generate the file name
    const fileName = `${quoteNumber}_${projectName}_${panelId}.json`;

    // Prepare the data to save
    const data = {
      projectName,
      soNumber,
      quoteNumber,
      panelId,
      creator,
      revision,
      panelType: panelSelect.value,
      parts: partsData.map(part => ({
        partType: part.partType,
        spaceName: part.spaceName,
        circuitNumber: part.circuitNumber,
        voltage: part.voltage,
        zone: part.zone,
        lightingLoad: part.lightingLoad,
        deviceMA: part.deviceMA,
        railNumber: part.railNumber,
        position: {
          left: part.partElement.style.left,
          top: part.partElement.style.top
        }
      })),
      manualWires: Array.from(wiringSvg.querySelectorAll('line')).map(line => ({
        x1: line.getAttribute('x1'),
        y1: line.getAttribute('y1'),
        x2: line.getAttribute('x2'),
        y2: line.getAttribute('y2'),
        stroke: line.getAttribute('stroke'),
        strokeWidth: line.getAttribute('stroke-width'),
        strokeDasharray: line.getAttribute('stroke-dasharray')
      }))
    };

    // Save the file
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);

    // Hide the popup
    document.getElementById('project-info-popup').style.display = 'none';
  };

  // Close the popup when Cancel is clicked
  document.getElementById('close-project-info-popup').addEventListener('click', () => {
    document.getElementById('project-info-popup').style.display = 'none';
  });

  // Load Functionality
  document.getElementById('load-button').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = JSON.parse(event.target.result);
        panelSelect.value = data.panelType;
        initializePanel();
        partsData = [];
        data.parts.forEach(partData => {
          addPart(partData.partType, partData.position);
          const part = partsData[partsData.length - 1];
          part.spaceName = partData.spaceName;
          part.voltage = partData.voltage;
          part.circuitNumber = partData.circuitNumber;
          part.zone = partData.zone;
          part.lightingLoad = partData.lightingLoad;
          part.deviceMA = partData.deviceMA;
          part.railNumber = partData.railNumber;
        });

        // Clear existing wires
        wiringSvg.innerHTML = '';
        wiringSvg.appendChild(defs);

        // Load manual wires
        if (data.manualWires) {
          data.manualWires.forEach(wire => {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', wire.x1);
            line.setAttribute('y1', wire.y1);
            line.setAttribute('x2', wire.x2);
            line.setAttribute('y2', wire.y2);
            line.setAttribute('stroke', wire.stroke);
            line.setAttribute('stroke-width', wire.strokeWidth);
            if (wire.strokeDasharray) {
              line.setAttribute('stroke-dasharray', wire.strokeDasharray);
            }
            wiringSvg.appendChild(line);
          });
        }

        updateSpaceTable();
        updateLoadSchedule();
      };
      reader.readAsText(file);
    };
    input.click();
  });


</script>
</body>
</html>
